"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.permissionsFromScope = exports.InternalAuthClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcAuth = generated_types_1.auth.auth;
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const grpc_js_1 = require("@grpc/grpc-js");
const package_json_1 = require("../../package.json");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
var Never = grpcAuth._GenerateApiTokenRequest.Never;
var Expires = grpcAuth._GenerateApiTokenRequest.Expires;
const sdk_core_1 = require("@gomomento/sdk-core");
const errors_1 = require("@gomomento/sdk-core/dist/src/errors");
class InternalAuthClient {
    constructor(props) {
        this.creds = props.credentialProvider;
        const headers = [new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`)];
        this.interceptors = [
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(InternalAuthClient.REQUEST_TIMEOUT_MS),
        ];
    }
    async generateAuthToken(scope, expiresIn) {
        const authClient = new grpcAuth.AuthClient(this.creds.getControlEndpoint(), grpc_js_1.ChannelCredentials.createSsl());
        const request = new grpcAuth._GenerateApiTokenRequest({
            auth_token: this.creds.getAuthToken(),
            permissions: permissionsFromScope(scope),
        });
        if (expiresIn.doesExpire()) {
            try {
                (0, utils_1.validateValidForSeconds)(expiresIn.seconds());
            }
            catch (err) {
                return new sdk_core_1.GenerateAuthToken.Error((0, errors_1.normalizeSdkError)(err));
            }
            request.expires = new Expires({
                valid_for_seconds: expiresIn.seconds(),
            });
        }
        else {
            request.never = new Never();
        }
        return await new Promise(resolve => {
            authClient.GenerateApiToken(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    resolve(new sdk_core_1.GenerateAuthToken.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    resolve(new sdk_core_1.GenerateAuthToken.Success(resp.api_key, resp.refresh_token, resp.endpoint, sdk_core_1.ExpiresAt.fromEpoch(resp.valid_until)));
                }
            });
        });
    }
    async refreshAuthToken(refreshToken) {
        const authClient = new grpcAuth.AuthClient(this.creds.getControlEndpoint(), grpc_js_1.ChannelCredentials.createSsl());
        const request = new grpcAuth._RefreshApiTokenRequest({
            api_key: this.creds.getAuthToken(),
            refresh_token: refreshToken,
        });
        return await new Promise(resolve => {
            authClient.RefreshApiToken(request, { interceptors: this.interceptors }, (err, resp) => {
                if (err || !resp) {
                    resolve(new sdk_core_1.RefreshAuthToken.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
                else {
                    resolve(new sdk_core_1.RefreshAuthToken.Success(resp.api_key, resp.refresh_token, resp.endpoint, sdk_core_1.ExpiresAt.fromEpoch(resp.valid_until)));
                }
            });
        });
    }
}
exports.InternalAuthClient = InternalAuthClient;
InternalAuthClient.REQUEST_TIMEOUT_MS = 60 * 1000;
function permissionsFromScope(scope) {
    const result = new grpcAuth._GenerateApiTokenRequest.Permissions();
    if (scope instanceof utils_1.InternalSuperUserPermissions) {
        result.super_user =
            grpcAuth._GenerateApiTokenRequest.SuperUserPermissions.SuperUser;
        return result;
    }
    else if (scope instanceof sdk_core_1.Permissions) {
        const explicitPermissions = new grpcAuth._GenerateApiTokenRequest.ExplicitPermissions();
        explicitPermissions.permissions = scope.permissions.map(p => tokenPermissionToGrpcPermission(p));
        result.explicit = explicitPermissions;
        return result;
    }
    throw new Error(`Unrecognized token scope: ${JSON.stringify(scope)}`);
}
exports.permissionsFromScope = permissionsFromScope;
function tokenPermissionToGrpcPermission(permission) {
    const result = new grpcAuth._GenerateApiTokenRequest.PermissionsType();
    if (permission instanceof sdk_core_1.TopicPermission) {
        result.topic_permissions = topicPermissionToGrpcPermission(permission);
        return result;
    }
    else if (permission instanceof sdk_core_1.CachePermission) {
        result.cache_permissions = cachePermissionToGrpcPermission(permission);
        return result;
    }
    throw new Error(`Unrecognized token permission: ${JSON.stringify(permission)}`);
}
function topicPermissionToGrpcPermission(permission) {
    switch (permission.topicRole) {
        case sdk_core_1.TopicRole.None:
            throw new Error('TopicRole.None not yet supported');
        case sdk_core_1.TopicRole.ReadWrite: {
            const grpcPermission = new grpcAuth._GenerateApiTokenRequest.PermissionsType.TopicPermissions();
            grpcPermission.role =
                grpcAuth._GenerateApiTokenRequest.TopicRole.TopicReadWrite;
            return grpcPermission;
        }
    }
    throw new Error(`Unrecognized topic permission: ${JSON.stringify(permission)}`);
}
function cachePermissionToGrpcPermission(permission) {
    switch (permission.cacheRole) {
        case sdk_core_1.CacheRole.None:
            throw new Error('CacheRole.None not yet supported');
        case sdk_core_1.CacheRole.ReadWrite: {
            const grpcPermission = new grpcAuth._GenerateApiTokenRequest.PermissionsType.CachePermissions();
            grpcPermission.role =
                grpcAuth._GenerateApiTokenRequest.CacheRole.CacheReadWrite;
            return grpcPermission;
        }
    }
    throw new Error(`Unrecognized cache permission: ${JSON.stringify(permission)}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJuYWwtYXV0aC1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJuYWwvaW50ZXJuYWwtYXV0aC1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0VBQWdEO0FBQ2hELElBQU8sUUFBUSxHQUFHLHNCQUFJLENBQUMsSUFBSSxDQUFDO0FBQzVCLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UsMkNBQThEO0FBQzlELHFEQUEyQztBQUMzQyxxRkFBNkU7QUFDN0UsdUVBR3FEO0FBQ3JELElBQU8sS0FBSyxHQUFHLFFBQVEsQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUM7QUFDdkQsSUFBTyxPQUFPLEdBQUcsUUFBUSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQztBQUMzRCxrREFhNkI7QUFHN0IsZ0VBQXNFO0FBRXRFLE1BQWEsa0JBQWtCO0lBTTdCLFlBQVksS0FBc0I7UUFDaEMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDdEMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLDRCQUFNLENBQUMsT0FBTyxFQUFFLFVBQVUsc0JBQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsWUFBWSxHQUFHO1lBQ2xCLElBQUksK0NBQXlCLENBQUMsT0FBTyxDQUFDLENBQUMsd0JBQXdCLEVBQUU7WUFDakUsSUFBQSxxREFBd0IsRUFBQyxrQkFBa0IsQ0FBQyxrQkFBa0IsQ0FBQztTQUNoRSxDQUFDO0lBQ0osQ0FBQztJQUVNLEtBQUssQ0FBQyxpQkFBaUIsQ0FDNUIsS0FBaUIsRUFDakIsU0FBb0I7UUFFcEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUN4QyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixFQUFFLEVBQy9CLDRCQUFrQixDQUFDLFNBQVMsRUFBRSxDQUMvQixDQUFDO1FBRUYsTUFBTSxPQUFP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RCxPQUFPLGNBQWMsQ0FBQztTQUN2QjtLQUNGO0lBRUQsTUFBTSxJQUFJLEtBQUssQ0FDYixrQ0FBa0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUMvRCxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YXV0aH0gZnJvbSAnQGdvbW9tZW50by9nZW5lcmF0ZWQtdHlwZXMnO1xuaW1wb3J0IGdycGNBdXRoID0gYXV0aC5hdXRoO1xuaW1wb3J0IHtIZWFkZXIsIEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXJ9IGZyb20gJy4vZ3JwYy9oZWFkZXJzLWludGVyY2VwdG9yJztcbmltcG9ydCB7Q2xpZW50VGltZW91dEludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvY2xpZW50LXRpbWVvdXQtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDaGFubmVsQ3JlZGVudGlhbHMsIEludGVyY2VwdG9yfSBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCB7dmVyc2lvbn0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCB7Y2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXJ9IGZyb20gJy4uL2Vycm9ycy9jYWNoZS1zZXJ2aWNlLWVycm9yLW1hcHBlcic7XG5pbXBvcnQge1xuICBJbnRlcm5hbFN1cGVyVXNlclBlcm1pc3Npb25zLFxuICB2YWxpZGF0ZVZhbGlkRm9yU2Vjb25kcyxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgTmV2ZXIgPSBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuTmV2ZXI7XG5pbXBvcnQgRXhwaXJlcyA9IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5FeHBpcmVzO1xuaW1wb3J0IHtcbiAgRXhwaXJlc0luLFxuICBFeHBpcmVzQXQsXG4gIENyZWRlbnRpYWxQcm92aWRlcixcbiAgUmVmcmVzaEF1dGhUb2tlbixcbiAgR2VuZXJhdGVBdXRoVG9rZW4sXG4gIFRva2VuU2NvcGUsXG4gIFBlcm1pc3Npb25zLFxuICBQZXJtaXNzaW9uLFxuICBUb3BpY1Blcm1pc3Npb24sXG4gIENhY2hlUGVybWlzc2lvbixcbiAgVG9waWNSb2xlLFxuICBDYWNoZVJvbGUsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUnO1xuaW1wb3J0IHtJQXV0aENsaWVudH0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzJztcbmltcG9ydCB7QXV0aENsaWVudFByb3BzfSBmcm9tICcuLi9hdXRoLWNsaWVudC1wcm9wcyc7XG5pbXBvcnQge25vcm1hbGl6ZVNka0Vycm9yfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2Vycm9ycyc7XG5cbmV4cG9ydCBjbGFzcyBJbnRlcm5hbEF1dGhDbGllbnQgaW1wbGVtZW50cyBJQXV0aENsaWVudCB7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFJFUVVFU1RfVElNRU9VVF9NUzogbnVtYmVyID0gNjAgKiAxMDAwO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgY3JlZHM6IENyZWRlbnRpYWxQcm92aWRlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBpbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG5cbiAgY29uc3RydWN0b3IocHJvcHM6IEF1dGhDbGllbnRQcm9wcykge1xuICAgIHRoaXMuY3JlZHMgPSBwcm9wcy5jcmVkZW50aWFsUHJvdmlkZXI7XG4gICAgY29uc3QgaGVhZGVycyA9IFtuZXcgSGVhZGVyKCdBZ2VudCcsIGBub2RlanM6JHt2ZXJzaW9ufWApXTtcbiAgICB0aGlzLmludGVyY2VwdG9ycyA9IFtcbiAgICAgIG5ldyBIZWFkZXJJbnRlcmNlcHRvclByb3ZpZGVyKGhlYWRlcnMpLmNyZWF0ZUhlYWRlcnNJbnRlcmNlcHRvcigpLFxuICAgICAgQ2xpZW50VGltZW91dEludGVyY2VwdG9yKEludGVybmFsQXV0aENsaWVudC5SRVFVRVNUX1RJTUVPVVRfTVMpLFxuICAgIF07XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2VuZXJhdGVBdXRoVG9rZW4oXG4gICAgc2NvcGU6IFRva2VuU2NvcGUsXG4gICAgZXhwaXJlc0luOiBFeHBpcmVzSW5cbiAgKTogUHJvbWlzZTxHZW5lcmF0ZUF1dGhUb2tlbi5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGF1dGhDbGllbnQgPSBuZXcgZ3JwY0F1dGguQXV0aENsaWVudChcbiAgICAgIHRoaXMuY3JlZHMuZ2V0Q29udHJvbEVuZHBvaW50KCksXG4gICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICApO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3Qoe1xuICAgICAgYXV0aF90b2tlbjogdGhpcy5jcmVkcy5nZXRBdXRoVG9rZW4oKSxcbiAgICAgIHBlcm1pc3Npb25zOiBwZXJtaXNzaW9uc0Zyb21TY29wZShzY29wZSksXG4gICAgfSk7XG5cbiAgICBpZiAoZXhwaXJlc0luLmRvZXNFeHBpcmUoKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFsaWRhdGVWYWxpZEZvclNlY29uZHMoZXhwaXJlc0luLnNlY29uZHMoKSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBHZW5lcmF0ZUF1dGhUb2tlbi5FcnJvcihub3JtYWxpemVTZGtFcnJvcihlcnIgYXMgRXJyb3IpKTtcbiAgICAgIH1cblxuICAgICAgcmVxdWVzdC5leHBpcmVzID0gbmV3IEV4cGlyZXMoe1xuICAgICAgICB2YWxpZF9mb3Jfc2Vjb25kczogZXhwaXJlc0luLnNlY29uZHMoKSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXF1ZXN0Lm5ldmVyID0gbmV3IE5ldmVyKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPEdlbmVyYXRlQXV0aFRva2VuLlJlc3BvbnNlPihyZXNvbHZlID0+IHtcbiAgICAgIGF1dGhDbGllbnQuR2VuZXJhdGVBcGlUb2tlbihcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge2ludGVyY2VwdG9yczogdGhpcy5pbnRlcmNlcHRvcnN9LFxuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKGVyciB8fCAhcmVzcCkge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgR2VuZXJhdGVBdXRoVG9rZW4uRXJyb3IoY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoZXJyKSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICBuZXcgR2VuZXJhdGVBdXRoVG9rZW4uU3VjY2VzcyhcbiAgICAgICAgICAgICAgICByZXNwLmFwaV9rZXksXG4gICAgICAgICAgICAgICAgcmVzcC5yZWZyZXNoX3Rva2VuLFxuICAgICAgICAgICAgICAgIHJlc3AuZW5kcG9pbnQsXG4gICAgICAgICAgICAgICAgRXhwaXJlc0F0LmZyb21FcG9jaChyZXNwLnZhbGlkX3VudGlsKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWZyZXNoQXV0aFRva2VuKFxuICAgIHJlZnJlc2hUb2tlbjogc3RyaW5nXG4gICk6IFByb21pc2U8UmVmcmVzaEF1dGhUb2tlbi5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGF1dGhDbGllbnQgPSBuZXcgZ3JwY0F1dGguQXV0aENsaWVudChcbiAgICAgIHRoaXMuY3JlZHMuZ2V0Q29udHJvbEVuZHBvaW50KCksXG4gICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICApO1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjQXV0aC5fUmVmcmVzaEFwaVRva2VuUmVxdWVzdCh7XG4gICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmdldEF1dGhUb2tlbigpLFxuICAgICAgcmVmcmVzaF90b2tlbjogcmVmcmVzaFRva2VuLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlPFJlZnJlc2hBdXRoVG9rZW4uUmVzcG9uc2U+KHJlc29sdmUgPT4ge1xuICAgICAgYXV0aENsaWVudC5SZWZyZXNoQXBpVG9rZW4oXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIHtpbnRlcmNlcHRvcnM6IHRoaXMuaW50ZXJjZXB0b3JzfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IFJlZnJlc2hBdXRoVG9rZW4uRXJyb3IoY2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoZXJyKSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKFxuICAgICAgICAgICAgICBuZXcgUmVmcmVzaEF1dGhUb2tlbi5TdWNjZXNzKFxuICAgICAgICAgICAgICAgIHJlc3AuYXBpX2tleSxcbiAgICAgICAgICAgICAgICByZXNwLnJlZnJlc2hfdG9rZW4sXG4gICAgICAgICAgICAgICAgcmVzcC5lbmRwb2ludCxcbiAgICAgICAgICAgICAgICBFeHBpcmVzQXQuZnJvbUVwb2NoKHJlc3AudmFsaWRfdW50aWwpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJtaXNzaW9uc0Zyb21TY29wZShcbiAgc2NvcGU6IFRva2VuU2NvcGVcbik6IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9ucyB7XG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnMoKTtcbiAgaWYgKHNjb3BlIGluc3RhbmNlb2YgSW50ZXJuYWxTdXBlclVzZXJQZXJtaXNzaW9ucykge1xuICAgIHJlc3VsdC5zdXBlcl91c2VyID1cbiAgICAgIGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5TdXBlclVzZXJQZXJtaXNzaW9ucy5TdXBlclVzZXI7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSBlbHNlIGlmIChzY29wZSBpbnN0YW5jZW9mIFBlcm1pc3Npb25zKSB7XG4gICAgY29uc3QgZXhwbGljaXRQZXJtaXNzaW9ucyA9XG4gICAgICBuZXcgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LkV4cGxpY2l0UGVybWlzc2lvbnMoKTtcbiAgICBleHBsaWNpdFBlcm1pc3Npb25zLnBlcm1pc3Npb25zID0gc2NvcGUucGVybWlzc2lvbnMubWFwKHAgPT5cbiAgICAgIHRva2VuUGVybWlzc2lvblRvR3JwY1Blcm1pc3Npb24ocClcbiAgICApO1xuICAgIHJlc3VsdC5leHBsaWNpdCA9IGV4cGxpY2l0UGVybWlzc2lvbnM7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYFVucmVjb2duaXplZCB0b2tlbiBzY29wZTogJHtKU09OLnN0cmluZ2lmeShzY29wZSl9YCk7XG59XG5cbmZ1bmN0aW9uIHRva2VuUGVybWlzc2lvblRvR3JwY1Blcm1pc3Npb24oXG4gIHBlcm1pc3Npb246IFBlcm1pc3Npb25cbik6IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUge1xuICBjb25zdCByZXN1bHQgPSBuZXcgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LlBlcm1pc3Npb25zVHlwZSgpO1xuICBpZiAocGVybWlzc2lvbiBpbnN0YW5jZW9mIFRvcGljUGVybWlzc2lvbikge1xuICAgIHJlc3VsdC50b3BpY19wZXJtaXNzaW9ucyA9IHRvcGljUGVybWlzc2lvblRvR3JwY1Blcm1pc3Npb24ocGVybWlzc2lvbik7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSBlbHNlIGlmIChwZXJtaXNzaW9uIGluc3RhbmNlb2YgQ2FjaGVQZXJtaXNzaW9uKSB7XG4gICAgcmVzdWx0LmNhY2hlX3Blcm1pc3Npb25zID0gY2FjaGVQZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihwZXJtaXNzaW9uKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihcbiAgICBgVW5yZWNvZ25pemVkIHRva2VuIHBlcm1pc3Npb246ICR7SlNPTi5zdHJpbmdpZnkocGVybWlzc2lvbil9YFxuICApO1xufVxuXG5mdW5jdGlvbiB0b3BpY1Blcm1pc3Npb25Ub0dycGNQZXJtaXNzaW9uKFxuICBwZXJtaXNzaW9uOiBUb3BpY1Blcm1pc3Npb25cbik6IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuVG9waWNQZXJtaXNzaW9ucyB7XG4gIHN3aXRjaCAocGVybWlzc2lvbi50b3BpY1JvbGUpIHtcbiAgICBjYXNlIFRvcGljUm9sZS5Ob25lOlxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUb3BpY1JvbGUuTm9uZSBub3QgeWV0IHN1cHBvcnRlZCcpO1xuICAgIGNhc2UgVG9waWNSb2xlLlJlYWRXcml0ZToge1xuICAgICAgY29uc3QgZ3JwY1Blcm1pc3Npb24gPVxuICAgICAgICBuZXcgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LlBlcm1pc3Npb25zVHlwZS5Ub3BpY1Blcm1pc3Npb25zKCk7XG4gICAgICBncnBjUGVybWlzc2lvbi5yb2xlID1cbiAgICAgICAgZ3JwY0F1dGguX0dlbmVyYXRlQXBpVG9rZW5SZXF1ZXN0LlRvcGljUm9sZS5Ub3BpY1JlYWRXcml0ZTtcbiAgICAgIHJldHVybiBncnBjUGVybWlzc2lvbjtcbiAgICB9XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgYFVucmVjb2duaXplZCB0b3BpYyBwZXJtaXNzaW9uOiAke0pTT04uc3RyaW5naWZ5KHBlcm1pc3Npb24pfWBcbiAgKTtcbn1cblxuZnVuY3Rpb24gY2FjaGVQZXJtaXNzaW9uVG9HcnBjUGVybWlzc2lvbihcbiAgcGVybWlzc2lvbjogQ2FjaGVQZXJtaXNzaW9uXG4pOiBncnBjQXV0aC5fR2VuZXJhdGVBcGlUb2tlblJlcXVlc3QuUGVybWlzc2lvbnNUeXBlLkNhY2hlUGVybWlzc2lvbnMge1xuICBzd2l0Y2ggKHBlcm1pc3Npb24uY2FjaGVSb2xlKSB7XG4gICAgY2FzZSBDYWNoZVJvbGUuTm9uZTpcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2FjaGVSb2xlLk5vbmUgbm90IHlldCBzdXBwb3J0ZWQnKTtcbiAgICBjYXNlIENhY2hlUm9sZS5SZWFkV3JpdGU6IHtcbiAgICAgIGNvbnN0IGdycGNQZXJtaXNzaW9uID1cbiAgICAgICAgbmV3IGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5QZXJtaXNzaW9uc1R5cGUuQ2FjaGVQZXJtaXNzaW9ucygpO1xuICAgICAgZ3JwY1Blcm1pc3Npb24ucm9sZSA9XG4gICAgICAgIGdycGNBdXRoLl9HZW5lcmF0ZUFwaVRva2VuUmVxdWVzdC5DYWNoZVJvbGUuQ2FjaGVSZWFkV3JpdGU7XG4gICAgICByZXR1cm4gZ3JwY1Blcm1pc3Npb247XG4gICAgfVxuICB9XG5cbiAgdGhyb3cgbmV3IEVycm9yKFxuICAgIGBVbnJlY29nbml6ZWQgY2FjaGUgcGVybWlzc2lvbjogJHtKU09OLnN0cmluZ2lmeShwZXJtaXNzaW9uKX1gXG4gICk7XG59XG4iXX0=