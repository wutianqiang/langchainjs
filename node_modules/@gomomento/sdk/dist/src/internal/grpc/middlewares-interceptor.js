"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.middlewaresInterceptor = void 0;
const grpc_js_1 = require("@grpc/grpc-js");
function middlewaresInterceptor(loggerFactory, middlewares) {
    return (options, nextCall) => {
        const middlewareRequestHandlers = middlewares.map(m => m.onNewRequest());
        // create a copy of the handlers and reverse it, because for the response life cycle actions we should call
        // the middlewares in the opposite order.
        const reversedMiddlewareRequestHandlers = [
            ...middlewareRequestHandlers,
        ].reverse();
        const requester = {
            start: function (metadata, listener, next) {
                const newListener = {
                    onReceiveMetadata: function (metadata, next) {
                        applyMiddlewareHandlers('onResponseMetadata', reversedMiddlewareRequestHandlers, (h) => (m) => h.onResponseMetadata(m), metadata, next);
                    },
                    onReceiveMessage: function (
                    // unfortunately grpc uses `any` in their type defs for these
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    message, 
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    next) {
                        applyMiddlewareHandlers('onResponseBody', reversedMiddlewareRequestHandlers, (h) => (request) => h.onResponseBody(request), message, next);
                    },
                    onReceiveStatus: function (status, next) {
                        applyMiddlewareHandlers('onResponseStatus', reversedMiddlewareRequestHandlers, (h) => (s) => h.onResponseStatus(s), status, next);
                    },
                };
                applyMiddlewareHandlers('onRequestMetadata', middlewareRequestHandlers, (h) => (m) => h.onRequestMetadata(m), metadata, (m) => next(m, newListener));
            },
            // unfortunately grpc uses `any` in their type defs for these
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            sendMessage: function (message, next) {
                applyMiddlewareHandlers('onRequestBody', middlewareRequestHandlers, 
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                (h) => (request) => h.onRequestBody(request), message, next);
            },
        };
        return new grpc_js_1.InterceptingCall(nextCall(options), requester);
    };
}
exports.middlewaresInterceptor = middlewaresInterceptor;
function applyMiddlewareHandlers(name, handlers, middlewareHandlerReduceFn, originalInput, nextFn) {
    let remainingHandlers = handlers;
    let middlewarePromise = Promise.resolve(originalInput);
    while (remainingHandlers.length > 0) {
        const nextHandler = middlewareHandlerReduceFn(remainingHandlers[0]);
        middlewarePromise = middlewarePromise
            .then(newT => nextHandler(newT))
            .catch(e => {
            throw e;
        });
        remainingHandlers = remainingHandlers.slice(1);
    }
    middlewarePromise
        .then(newT => nextFn(newT))
        .catch(e => {
        throw e;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlkZGxld2FyZXMtaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvaW50ZXJuYWwvZ3JwYy9taWRkbGV3YXJlcy1pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FRdUI7QUFTdkIsU0FBZ0Isc0JBQXNCLENBQ3BDLGFBQW1DLEVBQ25DLFdBQXlCO0lBRXpCLE9BQU8sQ0FBQyxPQUEyQixFQUFFLFFBQWtCLEVBQUUsRUFBRTtRQUN6RCxNQUFNLHlCQUF5QixHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUN6RSwyR0FBMkc7UUFDM0cseUNBQXlDO1FBQ3pDLE1BQU0saUNBQWlDLEdBQUc7WUFDeEMsR0FBRyx5QkFBeUI7U0FDN0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUVaLE1BQU0sU0FBUyxHQUFjO1lBQzNCLEtBQUssRUFBRSxVQUNMLFFBQWtCLEVBQ2xCLFFBQWtCLEVBQ2xCLElBQXNEO2dCQUV0RCxNQUFNLFdBQVcsR0FBYTtvQkFDNUIsaUJBQWlCLEVBQUUsVUFDakIsUUFBa0IsRUFDbEIsSUFBa0M7d0JBRWxDLHVCQUF1QixDQUNyQixvQkFBb0IsRUFDcEIsaUNBQWlDLEVBQ2pDLENBQUMsQ0FBMkIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFXLEVBQUUsRUFBRSxDQUMvQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLEVBQ3pCLFFBQVEsRUFDUixJQUFJLENBQ0wsQ0FBQztvQkFDSixDQUFDO29CQUNELGdCQUFnQixFQUFFO29CQUNoQiw2REFBNkQ7b0JBQzdELDhEQUE4RDtvQkFDOUQsT0FBWTtvQkFDWiw4REFBOEQ7b0JBQzlELElBQTRCO3dCQUU1Qix1QkFBdUIsQ0FDckIsZ0JBQWdCLEVBQ2hCLGlDQUFpQyxFQUNqQyxDQUFDLENBQTJCLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBZ0IsRUFBRSxFQUFFLENBQ3BELENBQUMsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEVBQzNCLE9BQU8sRUFDUCxJQUFJLENBQ0wsQ0FBQztvQkFDSixDQUFDO29CQUNELGVBQWUsRUFBRSxVQUNmLE1BQW9CLEVBQ3BCLElBQW9DO3dCQUVwQyx1QkFBdUIsQ0FDckIsa0JBQWtCLEVBQ2xCLGlDQUFpQyxFQUNqQyxDQUFDLENBQTJCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBZSxFQUFFLEVBQUUsQ0FDbkQsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxFQUN2QixNQUFNLEVBQ04sSUFBSSxDQUNMLENBQUM7b0JBQ0osQ0FBQztpQkFDRixDQUFDO2dCQUVGLHVCQUF1QixDQUNyQixtQkFBbUIsRUFDbkIseUJBQXlCLEVBQ3pCLENBQUMsQ0FBMkIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFXLEVBQUUsRUFBRSxDQUMvQyxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLEVBQ3hCLFFBQVEsRUFDUixDQUFDLENBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FDdEMsQ0FBQztZQUNKLENBQUM7WUFDRCw2REFBNkQ7WUFDN0QsOERBQThEO1lBQzlELFdBQVcsRUFBRSxVQUFVLE9BQVksRUFBRSxJQUE0QjtnQkFDL0QsdUJBQXVCLENBQ3JCLGVBQWUsRUFDZix5QkFBeUI7Z0JBQ3pCLDhEQUE4RDtnQkFDOUQsQ0FBQyxDQUEyQixFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQVksRUFBRSxFQUFFLENBQ2hELENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBa0IsQ0FBQyxFQUNyQyxPQUFPLEVBQ1AsSUFBSSxDQUNMLENBQUM7WUFDSixDQUFDO1NBQ0YsQ0FBQztRQUNGLE9BQU8sSUFBSSwwQkFBZ0IsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDNUQsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQXhGRCx3REF3RkM7QUFFRCxTQUFTLHVCQUF1QixDQUM5QixJQUFZLEVBQ1osUUFBb0MsRUFDcEMseUJBRXlCLEVBQ3pCLGFBQWdCLEVBQ2hCLE1BQXNCO0lBRXRCLElBQUksaUJBQWlCLEdBQUcsUUFBUSxDQUFDO0lBQ2pDLElBQUksaUJBQWlCLEdBQWUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNuRSxPQUFPLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7UUFDbkMsTUFBTSxXQUFXLEdBQUcseUJBQXlCLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwRSxpQkFBaUIsR0FBRyxpQkFBaUI7YUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQy9CLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNULE1BQU0sQ0FBQyxDQUFDO1FBQ1YsQ0FBQyxDQUFDLENBQUM7UUFDTCxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDaEQ7SUFFRCxpQkFBaUI7U0FDZCxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDMUIsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ1QsTUFBTSxDQUFDLENBQUM7SUFDVixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbnRlcmNlcHRpbmdDYWxsLFxuICBJbnRlcmNlcHRvcixcbiAgSW50ZXJjZXB0b3JPcHRpb25zLFxuICBMaXN0ZW5lcixcbiAgTWV0YWRhdGEsXG4gIFJlcXVlc3RlcixcbiAgU3RhdHVzT2JqZWN0LFxufSBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCB7TmV4dENhbGx9IGZyb20gJ0BncnBjL2dycGMtanMvYnVpbGQvc3JjL2NsaWVudC1pbnRlcmNlcHRvcnMnO1xuaW1wb3J0IHtcbiAgTWlkZGxld2FyZSxcbiAgTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyLFxufSBmcm9tICcuLi8uLi9jb25maWcvbWlkZGxld2FyZS9taWRkbGV3YXJlJztcbmltcG9ydCB7TWVzc2FnZX0gZnJvbSAnZ29vZ2xlLXByb3RvYnVmJztcbmltcG9ydCB7TW9tZW50b0xvZ2dlckZhY3Rvcnl9IGZyb20gJy4uLy4uLyc7XG5cbmV4cG9ydCBmdW5jdGlvbiBtaWRkbGV3YXJlc0ludGVyY2VwdG9yKFxuICBsb2dnZXJGYWN0b3J5OiBNb21lbnRvTG9nZ2VyRmFjdG9yeSxcbiAgbWlkZGxld2FyZXM6IE1pZGRsZXdhcmVbXVxuKTogSW50ZXJjZXB0b3Ige1xuICByZXR1cm4gKG9wdGlvbnM6IEludGVyY2VwdG9yT3B0aW9ucywgbmV4dENhbGw6IE5leHRDYWxsKSA9PiB7XG4gICAgY29uc3QgbWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyA9IG1pZGRsZXdhcmVzLm1hcChtID0+IG0ub25OZXdSZXF1ZXN0KCkpO1xuICAgIC8vIGNyZWF0ZSBhIGNvcHkgb2YgdGhlIGhhbmRsZXJzIGFuZCByZXZlcnNlIGl0LCBiZWNhdXNlIGZvciB0aGUgcmVzcG9uc2UgbGlmZSBjeWNsZSBhY3Rpb25zIHdlIHNob3VsZCBjYWxsXG4gICAgLy8gdGhlIG1pZGRsZXdhcmVzIGluIHRoZSBvcHBvc2l0ZSBvcmRlci5cbiAgICBjb25zdCByZXZlcnNlZE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMgPSBbXG4gICAgICAuLi5taWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJzLFxuICAgIF0ucmV2ZXJzZSgpO1xuXG4gICAgY29uc3QgcmVxdWVzdGVyOiBSZXF1ZXN0ZXIgPSB7XG4gICAgICBzdGFydDogZnVuY3Rpb24gKFxuICAgICAgICBtZXRhZGF0YTogTWV0YWRhdGEsXG4gICAgICAgIGxpc3RlbmVyOiBMaXN0ZW5lcixcbiAgICAgICAgbmV4dDogKG1ldGFkYXRhOiBNZXRhZGF0YSwgbGlzdGVuZXI6IExpc3RlbmVyKSA9PiB2b2lkXG4gICAgICApOiB2b2lkIHtcbiAgICAgICAgY29uc3QgbmV3TGlzdGVuZXI6IExpc3RlbmVyID0ge1xuICAgICAgICAgIG9uUmVjZWl2ZU1ldGFkYXRhOiBmdW5jdGlvbiAoXG4gICAgICAgICAgICBtZXRhZGF0YTogTWV0YWRhdGEsXG4gICAgICAgICAgICBuZXh0OiAobWV0YWRhdGE6IE1ldGFkYXRhKSA9PiB2b2lkXG4gICAgICAgICAgKTogdm9pZCB7XG4gICAgICAgICAgICBhcHBseU1pZGRsZXdhcmVIYW5kbGVycyhcbiAgICAgICAgICAgICAgJ29uUmVzcG9uc2VNZXRhZGF0YScsXG4gICAgICAgICAgICAgIHJldmVyc2VkTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICAgICAgICAgICAgKGg6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcikgPT4gKG06IE1ldGFkYXRhKSA9PlxuICAgICAgICAgICAgICAgIGgub25SZXNwb25zZU1ldGFkYXRhKG0pLFxuICAgICAgICAgICAgICBtZXRhZGF0YSxcbiAgICAgICAgICAgICAgbmV4dFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9uUmVjZWl2ZU1lc3NhZ2U6IGZ1bmN0aW9uIChcbiAgICAgICAgICAgIC8vIHVuZm9ydHVuYXRlbHkgZ3JwYyB1c2VzIGBhbnlgIGluIHRoZWlyIHR5cGUgZGVmcyBmb3IgdGhlc2VcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgICAgICBtZXNzYWdlOiBhbnksXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICAgICAgbmV4dDogKG1lc3NhZ2U6IGFueSkgPT4gdm9pZFxuICAgICAgICAgICk6IHZvaWQge1xuICAgICAgICAgICAgYXBwbHlNaWRkbGV3YXJlSGFuZGxlcnMoXG4gICAgICAgICAgICAgICdvblJlc3BvbnNlQm9keScsXG4gICAgICAgICAgICAgIHJldmVyc2VkTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICAgICAgICAgICAgKGg6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcikgPT4gKHJlcXVlc3Q6IE1lc3NhZ2UpID0+XG4gICAgICAgICAgICAgICAgaC5vblJlc3BvbnNlQm9keShyZXF1ZXN0KSxcbiAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgbmV4dFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIG9uUmVjZWl2ZVN0YXR1czogZnVuY3Rpb24gKFxuICAgICAgICAgICAgc3RhdHVzOiBTdGF0dXNPYmplY3QsXG4gICAgICAgICAgICBuZXh0OiAoc3RhdHVzOiBTdGF0dXNPYmplY3QpID0+IHZvaWRcbiAgICAgICAgICApOiB2b2lkIHtcbiAgICAgICAgICAgIGFwcGx5TWlkZGxld2FyZUhhbmRsZXJzKFxuICAgICAgICAgICAgICAnb25SZXNwb25zZVN0YXR1cycsXG4gICAgICAgICAgICAgIHJldmVyc2VkTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICAgICAgICAgICAgKGg6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcikgPT4gKHM6IFN0YXR1c09iamVjdCkgPT5cbiAgICAgICAgICAgICAgICBoLm9uUmVzcG9uc2VTdGF0dXMocyksXG4gICAgICAgICAgICAgIHN0YXR1cyxcbiAgICAgICAgICAgICAgbmV4dFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuXG4gICAgICAgIGFwcGx5TWlkZGxld2FyZUhhbmRsZXJzKFxuICAgICAgICAgICdvblJlcXVlc3RNZXRhZGF0YScsXG4gICAgICAgICAgbWlkZGxld2FyZVJlcXVlc3RIYW5kbGVycyxcbiAgICAgICAgICAoaDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKSA9PiAobTogTWV0YWRhdGEpID0+XG4gICAgICAgICAgICBoLm9uUmVxdWVzdE1ldGFkYXRhKG0pLFxuICAgICAgICAgIG1ldGFkYXRhLFxuICAgICAgICAgIChtOiBNZXRhZGF0YSkgPT4gbmV4dChtLCBuZXdMaXN0ZW5lcilcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgICAvLyB1bmZvcnR1bmF0ZWx5IGdycGMgdXNlcyBgYW55YCBpbiB0aGVpciB0eXBlIGRlZnMgZm9yIHRoZXNlXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgc2VuZE1lc3NhZ2U6IGZ1bmN0aW9uIChtZXNzYWdlOiBhbnksIG5leHQ6IChtZXNzYWdlOiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgYXBwbHlNaWRkbGV3YXJlSGFuZGxlcnMoXG4gICAgICAgICAgJ29uUmVxdWVzdEJvZHknLFxuICAgICAgICAgIG1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcnMsXG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICAgICAgICAoaDogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKSA9PiAocmVxdWVzdDogYW55KSA9PlxuICAgICAgICAgICAgaC5vblJlcXVlc3RCb2R5KHJlcXVlc3QgYXMgTWVzc2FnZSksXG4gICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICBuZXh0XG4gICAgICAgICk7XG4gICAgICB9LFxuICAgIH07XG4gICAgcmV0dXJuIG5ldyBJbnRlcmNlcHRpbmdDYWxsKG5leHRDYWxsKG9wdGlvbnMpLCByZXF1ZXN0ZXIpO1xuICB9O1xufVxuXG5mdW5jdGlvbiBhcHBseU1pZGRsZXdhcmVIYW5kbGVyczxUPihcbiAgbmFtZTogc3RyaW5nLFxuICBoYW5kbGVyczogTWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyW10sXG4gIG1pZGRsZXdhcmVIYW5kbGVyUmVkdWNlRm46IChcbiAgICBoOiBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJcbiAgKSA9PiAodDogVCkgPT4gUHJvbWlzZTxUPixcbiAgb3JpZ2luYWxJbnB1dDogVCxcbiAgbmV4dEZuOiAodDogVCkgPT4gdm9pZFxuKSB7XG4gIGxldCByZW1haW5pbmdIYW5kbGVycyA9IGhhbmRsZXJzO1xuICBsZXQgbWlkZGxld2FyZVByb21pc2U6IFByb21pc2U8VD4gPSBQcm9taXNlLnJlc29sdmUob3JpZ2luYWxJbnB1dCk7XG4gIHdoaWxlIChyZW1haW5pbmdIYW5kbGVycy5sZW5ndGggPiAwKSB7XG4gICAgY29uc3QgbmV4dEhhbmRsZXIgPSBtaWRkbGV3YXJlSGFuZGxlclJlZHVjZUZuKHJlbWFpbmluZ0hhbmRsZXJzWzBdKTtcbiAgICBtaWRkbGV3YXJlUHJvbWlzZSA9IG1pZGRsZXdhcmVQcm9taXNlXG4gICAgICAudGhlbihuZXdUID0+IG5leHRIYW5kbGVyKG5ld1QpKVxuICAgICAgLmNhdGNoKGUgPT4ge1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfSk7XG4gICAgcmVtYWluaW5nSGFuZGxlcnMgPSByZW1haW5pbmdIYW5kbGVycy5zbGljZSgxKTtcbiAgfVxuXG4gIG1pZGRsZXdhcmVQcm9taXNlXG4gICAgLnRoZW4obmV3VCA9PiBuZXh0Rm4obmV3VCkpXG4gICAgLmNhdGNoKGUgPT4ge1xuICAgICAgdGhyb3cgZTtcbiAgICB9KTtcbn1cbiJdfQ==