"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PubsubClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
var grpcPubsub = generated_types_1.pubsub.cache_client.pubsub;
// older versions of node don't have the global util variables https://github.com/nodejs/node/issues/20365
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const client_timeout_interceptor_1 = require("./grpc/client-timeout-interceptor");
const retry_interceptor_1 = require("./grpc/retry-interceptor");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const constants_1 = require("@grpc/grpc-js/build/src/constants");
const package_json_1 = require("../../package.json");
const idle_grpc_client_wrapper_1 = require("./grpc/idle-grpc-client-wrapper");
const middlewares_interceptor_1 = require("./grpc/middlewares-interceptor");
const __1 = require("../");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const AbstractPubsubClient_1 = require("@gomomento/sdk-core/dist/src/internal/clients/pubsub/AbstractPubsubClient");
class PubsubClient extends AbstractPubsubClient_1.AbstractPubsubClient {
    /**
     * @param {TopicClientProps} props
     */
    constructor(props) {
        super();
        this.configuration = props.configuration;
        this.credentialProvider = props.credentialProvider;
        this.logger = this.configuration.getLoggerFactory().getLogger(this);
        const grpcConfig = this.configuration
            .getTransportStrategy()
            .getGrpcConfig();
        this.validateRequestTimeout(grpcConfig.getDeadlineMillis());
        this.unaryRequestTimeoutMs =
            grpcConfig.getDeadlineMillis() || PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS;
        this.logger.debug(`Creating topic client using endpoint: '${this.credentialProvider.getCacheEndpoint()}'`);
        this.clientWrapper = new idle_grpc_client_wrapper_1.IdleGrpcClientWrapper({
            clientFactoryFn: () => new grpcPubsub.PubsubClient(this.credentialProvider.getCacheEndpoint(), grpc_js_1.ChannelCredentials.createSsl(), {
                // default value for max session memory is 10mb.  Under high load, it is easy to exceed this,
                // after which point all requests will fail with a client-side RESOURCE_EXHAUSTED exception.
                'grpc-node.max_session_memory': grpcConfig.getMaxSessionMemoryMb(),
                // This flag controls whether channels use a shared global pool of subchannels, or whether
                // each channel gets its own subchannel pool.  The default value is 0, meaning a single global
                // pool.  Setting it to 1 provides significant performance improvements when we instantiate more
                // than one grpc client.
                'grpc.use_local_subchannel_pool': 1,
            }),
            configuration: this.configuration,
        });
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('Agent', `nodejs:${package_json_1.version}`),
        ];
        this.unaryInterceptors = PubsubClient.initializeUnaryInterceptors(headers, props.configuration, this.unaryRequestTimeoutMs);
        this.streamingInterceptors =
            PubsubClient.initializeStreamingInterceptors(headers);
    }
    getEndpoint() {
        const endpoint = this.credentialProvider.getCacheEndpoint();
        this.logger.debug(`Using cache endpoint: ${endpoint}`);
        return endpoint;
    }
    validateRequestTimeout(timeout) {
        this.logger.debug(`Request timeout ms: ${String(timeout)}`);
        if (timeout !== undefined && timeout <= 0) {
            throw new __1.InvalidArgumentError('request timeout must be greater than zero.');
        }
    }
    async sendPublish(cacheName, topicName, value) {
        const topicValue = new grpcPubsub._TopicValue();
        if (typeof value === 'string') {
            topicValue.text = value;
        }
        else {
            topicValue.binary = value;
        }
        const request = new grpcPubsub._PublishRequest({
            cache_name: cacheName,
            topic: topicName,
            value: topicValue,
        });
        return await new Promise(resolve => {
            this.clientWrapper.getClient().Publish(request, {
                interceptors: this.unaryInterceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new __1.TopicPublish.Success());
                }
                else {
                    resolve(new __1.TopicPublish.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(err)));
                }
            });
        });
    }
    /**
     * @remark This method is responsible for restarting the stream if it ends unexpectedly.
     * Since we return a single subscription object to the user, we need to update it with the
     * unsubscribe function should we restart the stream. This is why we pass the subscription
     * state and subscription object to this method.
     *
     * Handling a cache not exists requires special care as well. In the most likely case,
     * when the subscription starts and the cache does not exist, we receive an error immediately.
     * We return an error from the subscribe method and do immediately unsubscribe. In a distinct,
     * unlikely but possible case, the user deletes the cache while the stream is running. In this
     * case we already returned a subscription object to the user, so we instead cancel the stream and
     * propagate an error to the user via the error handler.
     */
    sendSubscribe(options) {
        const request = new grpcPubsub._SubscriptionRequest({
            cache_name: options.cacheName,
            topic: options.topicName,
            resume_at_topic_sequence_number: options.subscriptionState.resumeAtTopicSequenceNumber,
        });
        const call = this.clientWrapper.getClient().Subscribe(request, {
            interceptors: this.streamingInterceptors,
        });
        options.subscriptionState.setSubscribed();
        // Allow the caller to cancel the stream.
        // Note that because we restart the stream on error or stream end,
        // we need to ensure we keep the same subscription object. That way
        // stream restarts are transparent to the caller.
        options.subscriptionState.unsubscribeFn = () => {
            call.cancel();
        };
        return new Promise(resolve => {
            const prepareCallbackOptions = {
                ...options,
                restartedDueToError: false,
                firstMessage: true,
                resolve,
            };
            call.on('data', this.prepareDataCallback(prepareCallbackOptions));
            call.on('error', this.prepareErrorCallback(prepareCallbackOptions));
            call.on('end', this.prepareEndCallback(prepareCallbackOptions));
        });
    }
    prepareDataCallback(options) {
        return (resp) => {
            if (options.firstMessage) {
                options.resolve(options.subscription);
            }
            options.firstMessage = false;
            if (resp === null || resp === void 0 ? void 0 : resp.item) {
                options.subscriptionState.lastTopicSequenceNumber =
                    resp.item.topic_sequence_number;
                if (resp.item.value.text) {
                    options.onItem(new __1.TopicItem(resp.item.value.text));
                }
                else if (resp.item.value.binary) {
                    options.onItem(new __1.TopicItem(resp.item.value.binary));
                }
                else {
                    this.logger.error('Received subscription item with unknown type; topic: %s', (0, utils_1.truncateString)(options.topicName));
                    options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item value type')), options.subscription);
                }
            }
            else if (resp === null || resp === void 0 ? void 0 : resp.heartbeat) {
                this.logger.trace('Received heartbeat from subscription stream; topic: %s', (0, utils_1.truncateString)(options.topicName));
            }
            else if (resp === null || resp === void 0 ? void 0 : resp.discontinuity) {
                this.logger.trace('Received discontinuity from subscription stream; topic: %s', (0, utils_1.truncateString)(options.topicName));
            }
            else {
                this.logger.error('Received unknown subscription item; topic: %s', (0, utils_1.truncateString)(options.topicName));
                options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item type')), options.subscription);
            }
        };
    }
    prepareErrorCallback(options) {
        return (err) => {
            // When the caller unsubscribes, we may get a follow on error, which we ignore.
            if (!options.subscriptionState.isSubscribed) {
                return;
            }
            const serviceError = err;
            const isRstStreamNoError = serviceError.code === constants_1.Status.INTERNAL &&
                serviceError.details === PubsubClient.RST_STREAM_NO_ERROR_MESSAGE;
            const momentoError = new __1.TopicSubscribe.Error((0, cache_service_error_mapper_1.cacheServiceErrorMapper)(serviceError));
            this.handleSubscribeError(options, momentoError, isRstStreamNoError);
        };
    }
    static initializeUnaryInterceptors(headers, configuration, requestTimeoutMs) {
        return [
            (0, middlewares_interceptor_1.middlewaresInterceptor)(configuration.getLoggerFactory(), configuration.getMiddlewares()),
            new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor(),
            (0, client_timeout_interceptor_1.ClientTimeoutInterceptor)(requestTimeoutMs),
            ...(0, retry_interceptor_1.createRetryInterceptorIfEnabled)(configuration.getLoggerFactory(), configuration.getRetryStrategy()),
        ];
    }
    // TODO https://github.com/momentohq/client-sdk-nodejs/issues/349
    // decide on streaming interceptors and middlewares
    static initializeStreamingInterceptors(headers) {
        return [new headers_interceptor_1.HeaderInterceptorProvider(headers).createHeadersInterceptor()];
    }
}
exports.PubsubClient = PubsubClient;
PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS = 5 * 1000;
PubsubClient.RST_STREAM_NO_ERROR_MESSAGE = 'Received RST_STREAM with code 0';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVic3ViLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbnRlcm5hbC9wdWJzdWItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGdFQUFrRDtBQUNsRCxJQUFPLFVBQVUsR0FBRyx3QkFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7QUFDL0MsMEdBQTBHO0FBQzFHLG9FQUE2RTtBQUM3RSxrRkFBMkU7QUFDM0UsZ0VBQXlFO0FBQ3pFLHFGQUE2RTtBQUM3RSwyQ0FBNEU7QUFDNUUsaUVBQXlEO0FBQ3pELHFEQUEyQztBQUMzQyw4RUFBc0U7QUFHdEUsNEVBQXNFO0FBRXRFLDJCQVFhO0FBQ2IsdUVBQTJFO0FBQzNFLG9IQUltRjtBQUVuRixNQUFhLFlBQWEsU0FBUSwyQ0FBb0I7SUFhcEQ7O09BRUc7SUFDSCxZQUFZLEtBQXVCO1FBQ2pDLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhO2FBQ2xDLG9CQUFvQixFQUFFO2FBQ3RCLGFBQWEsRUFBRSxDQUFDO1FBRW5CLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxxQkFBcUI7WUFDeEIsVUFBVSxDQUFDLGlCQUFpQixFQUFFLElBQUksWUFBWSxDQUFDLDBCQUEwQixDQUFDO1FBQzVFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUNmLDBDQUEwQyxJQUFJLENBQUMsa0JBQWtCLENB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WUFDcEUsTUFBTSxZQUFZLEdBQUcsSUFBSSxrQkFBYyxDQUFDLEtBQUssQ0FDM0MsSUFBQSxvREFBdUIsRUFBQyxZQUFZLENBQUMsQ0FDdEMsQ0FBQztZQUNGLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDdkUsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVPLE1BQU0sQ0FBQywyQkFBMkIsQ0FDeEMsT0FBaUIsRUFDakIsYUFBNEIsRUFDNUIsZ0JBQXdCO1FBRXhCLE9BQU87WUFDTCxJQUFBLGdEQUFzQixFQUNwQixhQUFhLENBQUMsZ0JBQWdCLEVBQUUsRUFDaEMsYUFBYSxDQUFDLGNBQWMsRUFBRSxDQUMvQjtZQUNELElBQUksK0NBQXlCLENBQUMsT0FBTyxDQUFDLENBQUMsd0JBQXdCLEVBQUU7WUFDakUsSUFBQSxxREFBd0IsRUFBQyxnQkFBZ0IsQ0FBQztZQUMxQyxHQUFHLElBQUEsbURBQStCLEVBQ2hDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxFQUNoQyxhQUFhLENBQUMsZ0JBQWdCLEVBQUUsQ0FDakM7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELGlFQUFpRTtJQUNqRSxtREFBbUQ7SUFDM0MsTUFBTSxDQUFDLCtCQUErQixDQUM1QyxPQUFpQjtRQUVqQixPQUFPLENBQUMsSUFBSSwrQ0FBeUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDLENBQUM7SUFDN0UsQ0FBQzs7QUFuUUgsb0NBb1FDO0FBL1B5Qix1Q0FBMEIsR0FBVyxDQUFDLEdBQUcsSUFBSSxDQUFDO0FBSzlDLHdDQUEyQixHQUNqRCxpQ0FBaUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7cHVic3VifSBmcm9tICdAZ29tb21lbnRvL2dlbmVyYXRlZC10eXBlcyc7XG5pbXBvcnQgZ3JwY1B1YnN1YiA9IHB1YnN1Yi5jYWNoZV9jbGllbnQucHVic3ViO1xuLy8gb2xkZXIgdmVyc2lvbnMgb2Ygbm9kZSBkb24ndCBoYXZlIHRoZSBnbG9iYWwgdXRpbCB2YXJpYWJsZXMgaHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2lzc3Vlcy8yMDM2NVxuaW1wb3J0IHtIZWFkZXIsIEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXJ9IGZyb20gJy4vZ3JwYy9oZWFkZXJzLWludGVyY2VwdG9yJztcbmltcG9ydCB7Q2xpZW50VGltZW91dEludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvY2xpZW50LXRpbWVvdXQtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtjcmVhdGVSZXRyeUludGVyY2VwdG9ySWZFbmFibGVkfSBmcm9tICcuL2dycGMvcmV0cnktaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtjYWNoZVNlcnZpY2VFcnJvck1hcHBlcn0gZnJvbSAnLi4vZXJyb3JzL2NhY2hlLXNlcnZpY2UtZXJyb3ItbWFwcGVyJztcbmltcG9ydCB7Q2hhbm5lbENyZWRlbnRpYWxzLCBJbnRlcmNlcHRvciwgU2VydmljZUVycm9yfSBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCB7U3RhdHVzfSBmcm9tICdAZ3JwYy9ncnBjLWpzL2J1aWxkL3NyYy9jb25zdGFudHMnO1xuaW1wb3J0IHt2ZXJzaW9ufSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHtJZGxlR3JwY0NsaWVudFdyYXBwZXJ9IGZyb20gJy4vZ3JwYy9pZGxlLWdycGMtY2xpZW50LXdyYXBwZXInO1xuaW1wb3J0IHtHcnBjQ2xpZW50V3JhcHBlcn0gZnJvbSAnLi9ncnBjL2dycGMtY2xpZW50LXdyYXBwZXInO1xuaW1wb3J0IHtUb3BpY0NsaWVudFByb3BzfSBmcm9tICcuLi90b3BpYy1jbGllbnQtcHJvcHMnO1xuaW1wb3J0IHttaWRkbGV3YXJlc0ludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvbWlkZGxld2FyZXMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDb25maWd1cmF0aW9ufSBmcm9tICcuLi9jb25maWcvY29uZmlndXJhdGlvbic7XG5pbXBvcnQge1xuICBDcmVkZW50aWFsUHJvdmlkZXIsXG4gIEludmFsaWRBcmd1bWVudEVycm9yLFxuICBNb21lbnRvTG9nZ2VyLFxuICBUb3BpY0l0ZW0sXG4gIFRvcGljUHVibGlzaCxcbiAgVG9waWNTdWJzY3JpYmUsXG4gIFVua25vd25FcnJvcixcbn0gZnJvbSAnLi4vJztcbmltcG9ydCB7dHJ1bmNhdGVTdHJpbmd9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHtcbiAgQWJzdHJhY3RQdWJzdWJDbGllbnQsXG4gIFNlbmRTdWJzY3JpYmVPcHRpb25zLFxuICBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zLFxufSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL2NsaWVudHMvcHVic3ViL0Fic3RyYWN0UHVic3ViQ2xpZW50JztcblxuZXhwb3J0IGNsYXNzIFB1YnN1YkNsaWVudCBleHRlbmRzIEFic3RyYWN0UHVic3ViQ2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnRXcmFwcGVyOiBHcnBjQ2xpZW50V3JhcHBlcjxncnBjUHVic3ViLlB1YnN1YkNsaWVudD47XG4gIHByaXZhdGUgcmVhZG9ubHkgY29uZmlndXJhdGlvbjogQ29uZmlndXJhdGlvbjtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGNyZWRlbnRpYWxQcm92aWRlcjogQ3JlZGVudGlhbFByb3ZpZGVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHVuYXJ5UmVxdWVzdFRpbWVvdXRNczogbnVtYmVyO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBERUZBVUxUX1JFUVVFU1RfVElNRU9VVF9NUzogbnVtYmVyID0gNSAqIDEwMDA7XG4gIHByb3RlY3RlZCByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgdW5hcnlJbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RyZWFtaW5nSW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFJTVF9TVFJFQU1fTk9fRVJST1JfTUVTU0FHRSA9XG4gICAgJ1JlY2VpdmVkIFJTVF9TVFJFQU0gd2l0aCBjb2RlIDAnO1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1RvcGljQ2xpZW50UHJvcHN9IHByb3BzXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogVG9waWNDbGllbnRQcm9wcykge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5jb25maWd1cmF0aW9uID0gcHJvcHMuY29uZmlndXJhdGlvbjtcbiAgICB0aGlzLmNyZWRlbnRpYWxQcm92aWRlciA9IHByb3BzLmNyZWRlbnRpYWxQcm92aWRlcjtcbiAgICB0aGlzLmxvZ2dlciA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCkuZ2V0TG9nZ2VyKHRoaXMpO1xuICAgIGNvbnN0IGdycGNDb25maWcgPSB0aGlzLmNvbmZpZ3VyYXRpb25cbiAgICAgIC5nZXRUcmFuc3BvcnRTdHJhdGVneSgpXG4gICAgICAuZ2V0R3JwY0NvbmZpZygpO1xuXG4gICAgdGhpcy52YWxpZGF0ZVJlcXVlc3RUaW1lb3V0KGdycGNDb25maWcuZ2V0RGVhZGxpbmVNaWxsaXMoKSk7XG4gICAgdGhpcy51bmFyeVJlcXVlc3RUaW1lb3V0TXMgPVxuICAgICAgZ3JwY0NvbmZpZy5nZXREZWFkbGluZU1pbGxpcygpIHx8IFB1YnN1YkNsaWVudC5ERUZBVUxUX1JFUVVFU1RfVElNRU9VVF9NUztcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBDcmVhdGluZyB0b3BpYyBjbGllbnQgdXNpbmcgZW5kcG9pbnQ6ICcke3RoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldENhY2hlRW5kcG9pbnQoKX0nYFxuICAgICk7XG5cbiAgICB0aGlzLmNsaWVudFdyYXBwZXIgPSBuZXcgSWRsZUdycGNDbGllbnRXcmFwcGVyKHtcbiAgICAgIGNsaWVudEZhY3RvcnlGbjogKCkgPT5cbiAgICAgICAgbmV3IGdycGNQdWJzdWIuUHVic3ViQ2xpZW50KFxuICAgICAgICAgIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldENhY2hlRW5kcG9pbnQoKSxcbiAgICAgICAgICBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKCksXG4gICAgICAgICAge1xuICAgICAgICAgICAgLy8gZGVmYXVsdCB2YWx1ZSBmb3IgbWF4IHNlc3Npb24gbWVtb3J5IGlzIDEwbWIuICBVbmRlciBoaWdoIGxvYWQsIGl0IGlzIGVhc3kgdG8gZXhjZWVkIHRoaXMsXG4gICAgICAgICAgICAvLyBhZnRlciB3aGljaCBwb2ludCBhbGwgcmVxdWVzdHMgd2lsbCBmYWlsIHdpdGggYSBjbGllbnQtc2lkZSBSRVNPVVJDRV9FWEhBVVNURUQgZXhjZXB0aW9uLlxuICAgICAgICAgICAgJ2dycGMtbm9kZS5tYXhfc2Vzc2lvbl9tZW1vcnknOiBncnBjQ29uZmlnLmdldE1heFNlc3Npb25NZW1vcnlNYigpLFxuICAgICAgICAgICAgLy8gVGhpcyBmbGFnIGNvbnRyb2xzIHdoZXRoZXIgY2hhbm5lbHMgdXNlIGEgc2hhcmVkIGdsb2JhbCBwb29sIG9mIHN1YmNoYW5uZWxzLCBvciB3aGV0aGVyXG4gICAgICAgICAgICAvLyBlYWNoIGNoYW5uZWwgZ2V0cyBpdHMgb3duIHN1YmNoYW5uZWwgcG9vbC4gIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDAsIG1lYW5pbmcgYSBzaW5nbGUgZ2xvYmFsXG4gICAgICAgICAgICAvLyBwb29sLiAgU2V0dGluZyBpdCB0byAxIHByb3ZpZGVzIHNpZ25pZmljYW50IHBlcmZvcm1hbmNlIGltcHJvdmVtZW50cyB3aGVuIHdlIGluc3RhbnRpYXRlIG1vcmVcbiAgICAgICAgICAgIC8vIHRoYW4gb25lIGdycGMgY2xpZW50LlxuICAgICAgICAgICAgJ2dycGMudXNlX2xvY2FsX3N1YmNoYW5uZWxfcG9vbCc6IDEsXG4gICAgICAgICAgfVxuICAgICAgICApLFxuICAgICAgY29uZmlndXJhdGlvbjogdGhpcy5jb25maWd1cmF0aW9uLFxuICAgIH0pO1xuXG4gICAgY29uc3QgaGVhZGVyczogSGVhZGVyW10gPSBbXG4gICAgICBuZXcgSGVhZGVyKCdBdXRob3JpemF0aW9uJywgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0QXV0aFRva2VuKCkpLFxuICAgICAgbmV3IEhlYWRlcignQWdlbnQnLCBgbm9kZWpzOiR7dmVyc2lvbn1gKSxcbiAgICBdO1xuICAgIHRoaXMudW5hcnlJbnRlcmNlcHRvcnMgPSBQdWJzdWJDbGllbnQuaW5pdGlhbGl6ZVVuYXJ5SW50ZXJjZXB0b3JzKFxuICAgICAgaGVhZGVycyxcbiAgICAgIHByb3BzLmNvbmZpZ3VyYXRpb24sXG4gICAgICB0aGlzLnVuYXJ5UmVxdWVzdFRpbWVvdXRNc1xuICAgICk7XG4gICAgdGhpcy5zdHJlYW1pbmdJbnRlcmNlcHRvcnMgPVxuICAgICAgUHVic3ViQ2xpZW50LmluaXRpYWxpemVTdHJlYW1pbmdJbnRlcmNlcHRvcnMoaGVhZGVycyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RW5kcG9pbnQoKTogc3RyaW5nIHtcbiAgICBjb25zdCBlbmRwb2ludCA9IHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldENhY2hlRW5kcG9pbnQoKTtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgVXNpbmcgY2FjaGUgZW5kcG9pbnQ6ICR7ZW5kcG9pbnR9YCk7XG4gICAgcmV0dXJuIGVuZHBvaW50O1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVJlcXVlc3RUaW1lb3V0KHRpbWVvdXQ/OiBudW1iZXIpIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgUmVxdWVzdCB0aW1lb3V0IG1zOiAke1N0cmluZyh0aW1lb3V0KX1gKTtcbiAgICBpZiAodGltZW91dCAhPT0gdW5kZWZpbmVkICYmIHRpbWVvdXQgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRBcmd1bWVudEVycm9yKFxuICAgICAgICAncmVxdWVzdCB0aW1lb3V0IG11c3QgYmUgZ3JlYXRlciB0aGFuIHplcm8uJ1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgc2VuZFB1Ymxpc2goXG4gICAgY2FjaGVOYW1lOiBzdHJpbmcsXG4gICAgdG9waWNOYW1lOiBzdHJpbmcsXG4gICAgdmFsdWU6IHN0cmluZyB8IFVpbnQ4QXJyYXlcbiAgKTogUHJvbWlzZTxUb3BpY1B1Ymxpc2guUmVzcG9uc2U+IHtcbiAgICBjb25zdCB0b3BpY1ZhbHVlID0gbmV3IGdycGNQdWJzdWIuX1RvcGljVmFsdWUoKTtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgdG9waWNWYWx1ZS50ZXh0ID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRvcGljVmFsdWUuYmluYXJ5ID0gdmFsdWU7XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWVzdCA9IG5ldyBncnBjUHVic3ViLl9QdWJsaXNoUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBjYWNoZU5hbWUsXG4gICAgICB0b3BpYzogdG9waWNOYW1lLFxuICAgICAgdmFsdWU6IHRvcGljVmFsdWUsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICB0aGlzLmNsaWVudFdyYXBwZXIuZ2V0Q2xpZW50KCkuUHVibGlzaChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAge1xuICAgICAgICAgIGludGVyY2VwdG9yczogdGhpcy51bmFyeUludGVyY2VwdG9ycyxcbiAgICAgICAgfSxcbiAgICAgICAgKGVyciwgcmVzcCkgPT4ge1xuICAgICAgICAgIGlmIChyZXNwKSB7XG4gICAgICAgICAgICByZXNvbHZlKG5ldyBUb3BpY1B1Ymxpc2guU3VjY2VzcygpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZShuZXcgVG9waWNQdWJsaXNoLkVycm9yKGNhY2hlU2VydmljZUVycm9yTWFwcGVyKGVycikpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHJlbWFyayBUaGlzIG1ldGhvZCBpcyByZXNwb25zaWJsZSBmb3IgcmVzdGFydGluZyB0aGUgc3RyZWFtIGlmIGl0IGVuZHMgdW5leHBlY3RlZGx5LlxuICAgKiBTaW5jZSB3ZSByZXR1cm4gYSBzaW5nbGUgc3Vic2NyaXB0aW9uIG9iamVjdCB0byB0aGUgdXNlciwgd2UgbmVlZCB0byB1cGRhdGUgaXQgd2l0aCB0aGVcbiAgICogdW5zdWJzY3JpYmUgZnVuY3Rpb24gc2hvdWxkIHdlIHJlc3RhcnQgdGhlIHN0cmVhbS4gVGhpcyBpcyB3aHkgd2UgcGFzcyB0aGUgc3Vic2NyaXB0aW9uXG4gICAqIHN0YXRlIGFuZCBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoaXMgbWV0aG9kLlxuICAgKlxuICAgKiBIYW5kbGluZyBhIGNhY2hlIG5vdCBleGlzdHMgcmVxdWlyZXMgc3BlY2lhbCBjYXJlIGFzIHdlbGwuIEluIHRoZSBtb3N0IGxpa2VseSBjYXNlLFxuICAgKiB3aGVuIHRoZSBzdWJzY3JpcHRpb24gc3RhcnRzIGFuZCB0aGUgY2FjaGUgZG9lcyBub3QgZXhpc3QsIHdlIHJlY2VpdmUgYW4gZXJyb3IgaW1tZWRpYXRlbHkuXG4gICAqIFdlIHJldHVybiBhbiBlcnJvciBmcm9tIHRoZSBzdWJzY3JpYmUgbWV0aG9kIGFuZCBkbyBpbW1lZGlhdGVseSB1bnN1YnNjcmliZS4gSW4gYSBkaXN0aW5jdCxcbiAgICogdW5saWtlbHkgYnV0IHBvc3NpYmxlIGNhc2UsIHRoZSB1c2VyIGRlbGV0ZXMgdGhlIGNhY2hlIHdoaWxlIHRoZSBzdHJlYW0gaXMgcnVubmluZy4gSW4gdGhpc1xuICAgKiBjYXNlIHdlIGFscmVhZHkgcmV0dXJuZWQgYSBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoZSB1c2VyLCBzbyB3ZSBpbnN0ZWFkIGNhbmNlbCB0aGUgc3RyZWFtIGFuZFxuICAgKiBwcm9wYWdhdGUgYW4gZXJyb3IgdG8gdGhlIHVzZXIgdmlhIHRoZSBlcnJvciBoYW5kbGVyLlxuICAgKi9cbiAgcHJvdGVjdGVkIHNlbmRTdWJzY3JpYmUoXG4gICAgb3B0aW9uczogU2VuZFN1YnNjcmliZU9wdGlvbnNcbiAgKTogUHJvbWlzZTxUb3BpY1N1YnNjcmliZS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY1B1YnN1Yi5fU3Vic2NyaXB0aW9uUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBvcHRpb25zLmNhY2hlTmFtZSxcbiAgICAgIHRvcGljOiBvcHRpb25zLnRvcGljTmFtZSxcbiAgICAgIHJlc3VtZV9hdF90b3BpY19zZXF1ZW5jZV9udW1iZXI6XG4gICAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUucmVzdW1lQXRUb3BpY1NlcXVlbmNlTnVtYmVyLFxuICAgIH0pO1xuXG4gICAgY29uc3QgY2FsbCA9IHRoaXMuY2xpZW50V3JhcHBlci5nZXRDbGllbnQoKS5TdWJzY3JpYmUocmVxdWVzdCwge1xuICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLnN0cmVhbWluZ0ludGVyY2VwdG9ycyxcbiAgICB9KTtcbiAgICBvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLnNldFN1YnNjcmliZWQoKTtcblxuICAgIC8vIEFsbG93IHRoZSBjYWxsZXIgdG8gY2FuY2VsIHRoZSBzdHJlYW0uXG4gICAgLy8gTm90ZSB0aGF0IGJlY2F1c2Ugd2UgcmVzdGFydCB0aGUgc3RyZWFtIG9uIGVycm9yIG9yIHN0cmVhbSBlbmQsXG4gICAgLy8gd2UgbmVlZCB0byBlbnN1cmUgd2Uga2VlcCB0aGUgc2FtZSBzdWJzY3JpcHRpb24gb2JqZWN0LiBUaGF0IHdheVxuICAgIC8vIHN0cmVhbSByZXN0YXJ0cyBhcmUgdHJhbnNwYXJlbnQgdG8gdGhlIGNhbGxlci5cbiAgICBvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLnVuc3Vic2NyaWJlRm4gPSAoKSA9PiB7XG4gICAgICBjYWxsLmNhbmNlbCgpO1xuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICBjb25zdCBwcmVwYXJlQ2FsbGJhY2tPcHRpb25zOiBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zID0ge1xuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICByZXN0YXJ0ZWREdWVUb0Vycm9yOiBmYWxzZSxcbiAgICAgICAgZmlyc3RNZXNzYWdlOiB0cnVlLFxuICAgICAgICByZXNvbHZlLFxuICAgICAgfTtcbiAgICAgIGNhbGwub24oJ2RhdGEnLCB0aGlzLnByZXBhcmVEYXRhQ2FsbGJhY2socHJlcGFyZUNhbGxiYWNrT3B0aW9ucykpO1xuICAgICAgY2FsbC5vbignZXJyb3InLCB0aGlzLnByZXBhcmVFcnJvckNhbGxiYWNrKHByZXBhcmVDYWxsYmFja09wdGlvbnMpKTtcbiAgICAgIGNhbGwub24oJ2VuZCcsIHRoaXMucHJlcGFyZUVuZENhbGxiYWNrKHByZXBhcmVDYWxsYmFja09wdGlvbnMpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZURhdGFDYWxsYmFjayhcbiAgICBvcHRpb25zOiBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zXG4gICk6IChyZXNwOiBncnBjUHVic3ViLl9TdWJzY3JpcHRpb25JdGVtKSA9PiB2b2lkIHtcbiAgICByZXR1cm4gKHJlc3A6IGdycGNQdWJzdWIuX1N1YnNjcmlwdGlvbkl0ZW0pID0+IHtcbiAgICAgIGlmIChvcHRpb25zLmZpcnN0TWVzc2FnZSkge1xuICAgICAgICBvcHRpb25zLnJlc29sdmUob3B0aW9ucy5zdWJzY3JpcHRpb24pO1xuICAgICAgfVxuICAgICAgb3B0aW9ucy5maXJzdE1lc3NhZ2UgPSBmYWxzZTtcblxuICAgICAgaWYgKHJlc3A/Lml0ZW0pIHtcbiAgICAgICAgb3B0aW9ucy5zdWJzY3JpcHRpb25TdGF0ZS5sYXN0VG9waWNTZXF1ZW5jZU51bWJlciA9XG4gICAgICAgICAgcmVzcC5pdGVtLnRvcGljX3NlcXVlbmNlX251bWJlcjtcbiAgICAgICAgaWYgKHJlc3AuaXRlbS52YWx1ZS50ZXh0KSB7XG4gICAgICAgICAgb3B0aW9ucy5vbkl0ZW0obmV3IFRvcGljSXRlbShyZXNwLml0ZW0udmFsdWUudGV4dCkpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3AuaXRlbS52YWx1ZS5iaW5hcnkpIHtcbiAgICAgICAgICBvcHRpb25zLm9uSXRlbShuZXcgVG9waWNJdGVtKHJlc3AuaXRlbS52YWx1ZS5iaW5hcnkpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgICdSZWNlaXZlZCBzdWJzY3JpcHRpb24gaXRlbSB3aXRoIHVua25vd24gdHlwZTsgdG9waWM6ICVzJyxcbiAgICAgICAgICAgIHRydW5jYXRlU3RyaW5nKG9wdGlvbnMudG9waWNOYW1lKVxuICAgICAgICAgICk7XG4gICAgICAgICAgb3B0aW9ucy5vbkVycm9yKFxuICAgICAgICAgICAgbmV3IFRvcGljU3Vic2NyaWJlLkVycm9yKFxuICAgICAgICAgICAgICBuZXcgVW5rbm93bkVycm9yKCdVbmtub3duIGl0ZW0gdmFsdWUgdHlwZScpXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgb3B0aW9ucy5zdWJzY3JpcHRpb25cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHJlc3A/LmhlYXJ0YmVhdCkge1xuICAgICAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgICAgICAnUmVjZWl2ZWQgaGVhcnRiZWF0IGZyb20gc3Vic2NyaXB0aW9uIHN0cmVhbTsgdG9waWM6ICVzJyxcbiAgICAgICAgICB0cnVuY2F0ZVN0cmluZyhvcHRpb25zLnRvcGljTmFtZSlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzcD8uZGlzY29udGludWl0eSkge1xuICAgICAgICB0aGlzLmxvZ2dlci50cmFjZShcbiAgICAgICAgICAnUmVjZWl2ZWQgZGlzY29udGludWl0eSBmcm9tIHN1YnNjcmlwdGlvbiBzdHJlYW07IHRvcGljOiAlcycsXG4gICAgICAgICAgdHJ1bmNhdGVTdHJpbmcob3B0aW9ucy50b3BpY05hbWUpXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAnUmVjZWl2ZWQgdW5rbm93biBzdWJzY3JpcHRpb24gaXRlbTsgdG9waWM6ICVzJyxcbiAgICAgICAgICB0cnVuY2F0ZVN0cmluZyhvcHRpb25zLnRvcGljTmFtZSlcbiAgICAgICAgKTtcbiAgICAgICAgb3B0aW9ucy5vbkVycm9yKFxuICAgICAgICAgIG5ldyBUb3BpY1N1YnNjcmliZS5FcnJvcihuZXcgVW5rbm93bkVycm9yKCdVbmtub3duIGl0ZW0gdHlwZScpKSxcbiAgICAgICAgICBvcHRpb25zLnN1YnNjcmlwdGlvblxuICAgICAgICApO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHByZXBhcmVFcnJvckNhbGxiYWNrKFxuICAgIG9wdGlvbnM6IFByZXBhcmVTdWJzY3JpYmVDYWxsYmFja09wdGlvbnNcbiAgKTogKGVycjogRXJyb3IpID0+IHZvaWQge1xuICAgIHJldHVybiAoZXJyOiBFcnJvcikgPT4ge1xuICAgICAgLy8gV2hlbiB0aGUgY2FsbGVyIHVuc3Vic2NyaWJlcywgd2UgbWF5IGdldCBhIGZvbGxvdyBvbiBlcnJvciwgd2hpY2ggd2UgaWdub3JlLlxuICAgICAgaWYgKCFvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLmlzU3Vic2NyaWJlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNlcnZpY2VFcnJvciA9IGVyciBhcyB1bmtub3duIGFzIFNlcnZpY2VFcnJvcjtcbiAgICAgIGNvbnN0IGlzUnN0U3RyZWFtTm9FcnJvciA9XG4gICAgICAgIHNlcnZpY2VFcnJvci5jb2RlID09PSBTdGF0dXMuSU5URVJOQUwgJiZcbiAgICAgICAgc2VydmljZUVycm9yLmRldGFpbHMgPT09IFB1YnN1YkNsaWVudC5SU1RfU1RSRUFNX05PX0VSUk9SX01FU1NBR0U7XG4gICAgICBjb25zdCBtb21lbnRvRXJyb3IgPSBuZXcgVG9waWNTdWJzY3JpYmUuRXJyb3IoXG4gICAgICAgIGNhY2hlU2VydmljZUVycm9yTWFwcGVyKHNlcnZpY2VFcnJvcilcbiAgICAgICk7XG4gICAgICB0aGlzLmhhbmRsZVN1YnNjcmliZUVycm9yKG9wdGlvbnMsIG1vbWVudG9FcnJvciwgaXNSc3RTdHJlYW1Ob0Vycm9yKTtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgaW5pdGlhbGl6ZVVuYXJ5SW50ZXJjZXB0b3JzKFxuICAgIGhlYWRlcnM6IEhlYWRlcltdLFxuICAgIGNvbmZpZ3VyYXRpb246IENvbmZpZ3VyYXRpb24sXG4gICAgcmVxdWVzdFRpbWVvdXRNczogbnVtYmVyXG4gICk6IEludGVyY2VwdG9yW10ge1xuICAgIHJldHVybiBbXG4gICAgICBtaWRkbGV3YXJlc0ludGVyY2VwdG9yKFxuICAgICAgICBjb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKSxcbiAgICAgICAgY29uZmlndXJhdGlvbi5nZXRNaWRkbGV3YXJlcygpXG4gICAgICApLFxuICAgICAgbmV3IEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXIoaGVhZGVycykuY3JlYXRlSGVhZGVyc0ludGVyY2VwdG9yKCksXG4gICAgICBDbGllbnRUaW1lb3V0SW50ZXJjZXB0b3IocmVxdWVzdFRpbWVvdXRNcyksXG4gICAgICAuLi5jcmVhdGVSZXRyeUludGVyY2VwdG9ySWZFbmFibGVkKFxuICAgICAgICBjb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKSxcbiAgICAgICAgY29uZmlndXJhdGlvbi5nZXRSZXRyeVN0cmF0ZWd5KClcbiAgICAgICksXG4gICAgXTtcbiAgfVxuXG4gIC8vIFRPRE8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudG9ocS9jbGllbnQtc2RrLW5vZGVqcy9pc3N1ZXMvMzQ5XG4gIC8vIGRlY2lkZSBvbiBzdHJlYW1pbmcgaW50ZXJjZXB0b3JzIGFuZCBtaWRkbGV3YXJlc1xuICBwcml2YXRlIHN0YXRpYyBpbml0aWFsaXplU3RyZWFtaW5nSW50ZXJjZXB0b3JzKFxuICAgIGhlYWRlcnM6IEhlYWRlcltdXG4gICk6IEludGVyY2VwdG9yW10ge1xuICAgIHJldHVybiBbbmV3IEhlYWRlckludGVyY2VwdG9yUHJvdmlkZXIoaGVhZGVycykuY3JlYXRlSGVhZGVyc0ludGVyY2VwdG9yKCldO1xuICB9XG59XG4iXX0=