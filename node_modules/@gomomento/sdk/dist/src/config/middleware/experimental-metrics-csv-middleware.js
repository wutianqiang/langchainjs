"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExperimentalMetricsCsvMiddleware = void 0;
const fs = require("fs");
function headerFields() {
    return [
        'numActiveRequestsAtStart',
        'numActiveRequestsAtFinish',
        'requestType',
        'status',
        'startTime',
        'requestBodyTime',
        'endTime',
        'duration',
        'requestSize',
        'responseSize',
    ];
}
class ExperimentalMetricsCsvMiddlewareRequestHandler {
    constructor(logger, csvPath) {
        this.logger = logger;
        this.csvPath = csvPath;
        this.numActiveRequestsAtStart =
            ++ExperimentalMetricsCsvMiddleware.numActiveRequests;
        this.startTime = new Date().getTime();
        this.receivedResponseBody = false;
        this.receivedResponseStatus = false;
    }
    onRequestBody(request) {
        this.requestSize = request.serializeBinary().length;
        this.requestType = request.constructor.name;
        this.requestBodyTime = new Date().getTime();
        return Promise.resolve(request);
    }
    onRequestMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseBody(response) {
        if (response !== null) {
            this.responseSize = response.serializeBinary().length;
        }
        else {
            this.responseSize = 0;
        }
        this.receivedResponseBody = true;
        if (this.done())
            this.recordMetrics();
        return Promise.resolve(response);
    }
    onResponseMetadata(metadata) {
        return Promise.resolve(metadata);
    }
    onResponseStatus(status) {
        this.receivedResponseStatus = true;
        this.responseStatusCode = status.code;
        if (this.done())
            this.recordMetrics();
        return Promise.resolve(status);
    }
    done() {
        return this.receivedResponseBody && this.receivedResponseStatus;
    }
    recordMetrics() {
        const endTime = new Date().getTime();
        const metrics = {
            numActiveRequestsAtStart: this.numActiveRequestsAtStart,
            numActiveRequestsAtFinish: ExperimentalMetricsCsvMiddleware.numActiveRequests,
            requestType: this.requestType,
            status: this.responseStatusCode,
            startTime: this.startTime,
            requestBodyTime: this.requestBodyTime,
            endTime: endTime,
            duration: endTime - this.startTime,
            requestSize: this.requestSize,
            responseSize: this.responseSize,
        };
        const csvRow = [
            metrics.numActiveRequestsAtStart,
            metrics.numActiveRequestsAtFinish,
            metrics.requestType,
            metrics.status,
            metrics.startTime,
            metrics.requestBodyTime,
            metrics.endTime,
            metrics.duration,
            metrics.requestSize,
            metrics.responseSize,
        ].join(',');
        fs.appendFile(this.csvPath, `${csvRow}\n`, err => {
            if (err !== null) {
                this.logger.error('Error writing to metrics csv file at path: %s : %s', this.csvPath, err);
            }
        });
        ExperimentalMetricsCsvMiddleware.numActiveRequests--;
    }
}
/**
 * This middleware enables per-request client-side metrics.  Metrics for each
 * request will be written to a CSV file; this file can be analyzed or shared
 * with Momento to diagnose performance issues.
 *
 * The metrics format is currently considered experimental; in a future release,
 * once the format is considered stable, this class will be renamed to remove
 * the Experimental prefix.
 *
 * WARNING: enabling this middleware may have minor performance implications,
 * so enable with caution.
 *
 * WARNING: depending on your request volume, the CSV file size may grow quickly;
 * neither sampling nor file compression / rotation are included at this time
 * (though they may be added in the future).
 *
 * See `advanced.ts` in the examples directory for an example of how to set up
 * your {Configuration} to enable this middleware.
 */
class ExperimentalMetricsCsvMiddleware {
    constructor(csvPath, loggerFactory) {
        this.csvPath = csvPath;
        this.logger = loggerFactory.getLogger(this);
        fs.writeFileSync(this.csvPath, `${headerFields().join(',')}\n`);
    }
    onNewRequest() {
        return new ExperimentalMetricsCsvMiddlewareRequestHandler(this.logger, this.csvPath);
    }
}
exports.ExperimentalMetricsCsvMiddleware = ExperimentalMetricsCsvMiddleware;
ExperimentalMetricsCsvMiddleware.numActiveRequests = 0;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudGFsLW1ldHJpY3MtY3N2LW1pZGRsZXdhcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29uZmlnL21pZGRsZXdhcmUvZXhwZXJpbWVudGFsLW1ldHJpY3MtY3N2LW1pZGRsZXdhcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBR0EseUJBQXlCO0FBR3pCLFNBQVMsWUFBWTtJQUNuQixPQUFPO1FBQ0wsMEJBQTBCO1FBQzFCLDJCQUEyQjtRQUMzQixhQUFhO1FBQ2IsUUFBUTtRQUNSLFdBQVc7UUFDWCxpQkFBaUI7UUFDakIsU0FBUztRQUNULFVBQVU7UUFDVixhQUFhO1FBQ2IsY0FBYztLQUNmLENBQUM7QUFDSixDQUFDO0FBNkNELE1BQU0sOENBQThDO0lBZ0JsRCxZQUFZLE1BQXFCLEVBQUUsT0FBZTtRQUNoRCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsd0JBQXdCO1lBQzNCLEVBQUUsZ0NBQWdDLENBQUMsaUJBQWlCLENBQUM7UUFDdkQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRXRDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxLQUFLLENBQUM7UUFDbEMsSUFBSSxDQUFDLHNCQUFzQixHQUFHLEtBQUssQ0FBQztJQUN0QyxDQUFDO0lBRUQsYUFBYSxDQUFDLE9BQWdCO1FBQzVCLElBQUksQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsRUFBRSxDQUFDLE1BQU0sQ0FBQztRQUNwRCxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1FBQzVDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM1QyxPQUFPLE9BQU8sQ0FB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OztHQWtCRztBQUNILE1BQWEsZ0NBQWdDO0lBTTNDLFlBQVksT0FBZSxFQUFFLGFBQW1DO1FBQzlELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRCxZQUFZO1FBQ1YsT0FBTyxJQUFJLDhDQUE4QyxDQUN2RCxJQUFJLENBQUMsTUFBTSxFQUNYLElBQUksQ0FBQyxPQUFPLENBQ2IsQ0FBQztJQUNKLENBQUM7O0FBakJILDRFQWtCQztBQWpCUSxrREFBaUIsR0FBRyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01pZGRsZXdhcmUsIE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlcn0gZnJvbSAnLi9taWRkbGV3YXJlJztcbmltcG9ydCB7TWV0YWRhdGEsIFN0YXR1c09iamVjdH0gZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQge01lc3NhZ2V9IGZyb20gJ2dvb2dsZS1wcm90b2J1Zic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQge01vbWVudG9Mb2dnZXIsIE1vbWVudG9Mb2dnZXJGYWN0b3J5fSBmcm9tICcuLi8uLi8nO1xuXG5mdW5jdGlvbiBoZWFkZXJGaWVsZHMoKTogQXJyYXk8c3RyaW5nPiB7XG4gIHJldHVybiBbXG4gICAgJ251bUFjdGl2ZVJlcXVlc3RzQXRTdGFydCcsXG4gICAgJ251bUFjdGl2ZVJlcXVlc3RzQXRGaW5pc2gnLFxuICAgICdyZXF1ZXN0VHlwZScsXG4gICAgJ3N0YXR1cycsXG4gICAgJ3N0YXJ0VGltZScsXG4gICAgJ3JlcXVlc3RCb2R5VGltZScsXG4gICAgJ2VuZFRpbWUnLFxuICAgICdkdXJhdGlvbicsXG4gICAgJ3JlcXVlc3RTaXplJyxcbiAgICAncmVzcG9uc2VTaXplJyxcbiAgXTtcbn1cblxuaW50ZXJmYWNlIFJlcXVlc3RNZXRyaWNzIHtcbiAgLyoqXG4gICAqIG51bWJlciBvZiByZXF1ZXN0cyBhY3RpdmUgYXQgdGhlIHN0YXJ0IG9mIHRoZSByZXF1ZXN0XG4gICAqL1xuICBudW1BY3RpdmVSZXF1ZXN0c0F0U3RhcnQ6IG51bWJlcjtcbiAgLyoqXG4gICAqIG51bWJlciBvZiByZXF1ZXN0cyBhY3RpdmUgYXQgdGhlIGZpbmlzaCBvZiB0aGUgcmVxdWVzdCAoaW5jbHVkaW5nIHRoZSByZXF1ZXN0IGl0c2VsZilcbiAgICovXG4gIG51bUFjdGl2ZVJlcXVlc3RzQXRGaW5pc2g6IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSBnZW5lcmF0ZWQgZ3JwYyBvYmplY3QgdHlwZSBvZiB0aGUgcmVxdWVzdFxuICAgKi9cbiAgcmVxdWVzdFR5cGU6IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBncnBjIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZVxuICAgKi9cbiAgc3RhdHVzOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgdGltZSB0aGUgcmVxdWVzdCBzdGFydGVkIChtaWxsaXMgc2luY2UgZXBvY2gpXG4gICAqL1xuICBzdGFydFRpbWU6IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSB0aW1lIHRoZSBib2R5IG9mIHRoZSByZXF1ZXN0IHdhcyBhdmFpbGFibGUgdG8gdGhlIGdycGMgbGlicmFyeSAobWlsbGlzIHNpbmNlIGVwb2NoKVxuICAgKi9cbiAgcmVxdWVzdEJvZHlUaW1lOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgdGltZSB0aGUgcmVxdWVzdCBjb21wbGV0ZWQgKG1pbGxpcyBzaW5jZSBlcG9jaClcbiAgICovXG4gIGVuZFRpbWU6IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSBkdXJhdGlvbiBvZiB0aGUgcmVxdWVzdCAoaW4gbWlsbGlzKVxuICAgKi9cbiAgZHVyYXRpb246IG51bWJlcjtcbiAgLyoqXG4gICAqIFRoZSBzaXplIG9mIHRoZSByZXF1ZXN0IGJvZHkgaW4gYnl0ZXNcbiAgICovXG4gIHJlcXVlc3RTaXplOiBudW1iZXI7XG4gIC8qKlxuICAgKiBUaGUgc2l6ZSBvZiB0aGUgcmVzcG9uc2UgYm9keSBpbiBieXRlc1xuICAgKi9cbiAgcmVzcG9uc2VTaXplOiBudW1iZXI7XG59XG5cbmNsYXNzIEV4cGVyaW1lbnRhbE1ldHJpY3NDc3ZNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJcbiAgaW1wbGVtZW50cyBNaWRkbGV3YXJlUmVxdWVzdEhhbmRsZXJcbntcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgY3N2UGF0aDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IG51bUFjdGl2ZVJlcXVlc3RzQXRTdGFydDogbnVtYmVyO1xuICBwcml2YXRlIHJlYWRvbmx5IHN0YXJ0VGltZTogbnVtYmVyO1xuICBwcml2YXRlIHJlcXVlc3RCb2R5VGltZTogbnVtYmVyO1xuICBwcml2YXRlIHJlcXVlc3RUeXBlOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVxdWVzdFNpemU6IG51bWJlcjtcbiAgcHJpdmF0ZSByZXNwb25zZVN0YXR1c0NvZGU6IG51bWJlcjtcbiAgcHJpdmF0ZSByZXNwb25zZVNpemU6IG51bWJlcjtcblxuICBwcml2YXRlIHJlY2VpdmVkUmVzcG9uc2VCb2R5OiBib29sZWFuO1xuICBwcml2YXRlIHJlY2VpdmVkUmVzcG9uc2VTdGF0dXM6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IobG9nZ2VyOiBNb21lbnRvTG9nZ2VyLCBjc3ZQYXRoOiBzdHJpbmcpIHtcbiAgICB0aGlzLmxvZ2dlciA9IGxvZ2dlcjtcbiAgICB0aGlzLmNzdlBhdGggPSBjc3ZQYXRoO1xuICAgIHRoaXMubnVtQWN0aXZlUmVxdWVzdHNBdFN0YXJ0ID1cbiAgICAgICsrRXhwZXJpbWVudGFsTWV0cmljc0Nzdk1pZGRsZXdhcmUubnVtQWN0aXZlUmVxdWVzdHM7XG4gICAgdGhpcy5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcblxuICAgIHRoaXMucmVjZWl2ZWRSZXNwb25zZUJvZHkgPSBmYWxzZTtcbiAgICB0aGlzLnJlY2VpdmVkUmVzcG9uc2VTdGF0dXMgPSBmYWxzZTtcbiAgfVxuXG4gIG9uUmVxdWVzdEJvZHkocmVxdWVzdDogTWVzc2FnZSk6IFByb21pc2U8TWVzc2FnZT4ge1xuICAgIHRoaXMucmVxdWVzdFNpemUgPSByZXF1ZXN0LnNlcmlhbGl6ZUJpbmFyeSgpLmxlbmd0aDtcbiAgICB0aGlzLnJlcXVlc3RUeXBlID0gcmVxdWVzdC5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgIHRoaXMucmVxdWVzdEJvZHlUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXF1ZXN0KTtcbiAgfVxuXG4gIG9uUmVxdWVzdE1ldGFkYXRhKG1ldGFkYXRhOiBNZXRhZGF0YSk6IFByb21pc2U8TWV0YWRhdGE+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1ldGFkYXRhKTtcbiAgfVxuXG4gIG9uUmVzcG9uc2VCb2R5KHJlc3BvbnNlOiBNZXNzYWdlIHwgbnVsbCk6IFByb21pc2U8TWVzc2FnZSB8IG51bGw+IHtcbiAgICBpZiAocmVzcG9uc2UgIT09IG51bGwpIHtcbiAgICAgIHRoaXMucmVzcG9uc2VTaXplID0gcmVzcG9uc2Uuc2VyaWFsaXplQmluYXJ5KCkubGVuZ3RoO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlc3BvbnNlU2l6ZSA9IDA7XG4gICAgfVxuICAgIHRoaXMucmVjZWl2ZWRSZXNwb25zZUJvZHkgPSB0cnVlO1xuICAgIGlmICh0aGlzLmRvbmUoKSkgdGhpcy5yZWNvcmRNZXRyaWNzKCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXNwb25zZSk7XG4gIH1cblxuICBvblJlc3BvbnNlTWV0YWRhdGEobWV0YWRhdGE6IE1ldGFkYXRhKTogUHJvbWlzZTxNZXRhZGF0YT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWV0YWRhdGEpO1xuICB9XG5cbiAgb25SZXNwb25zZVN0YXR1cyhzdGF0dXM6IFN0YXR1c09iamVjdCk6IFByb21pc2U8U3RhdHVzT2JqZWN0PiB7XG4gICAgdGhpcy5yZWNlaXZlZFJlc3BvbnNlU3RhdHVzID0gdHJ1ZTtcbiAgICB0aGlzLnJlc3BvbnNlU3RhdHVzQ29kZSA9IHN0YXR1cy5jb2RlO1xuICAgIGlmICh0aGlzLmRvbmUoKSkgdGhpcy5yZWNvcmRNZXRyaWNzKCk7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzdGF0dXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBkb25lKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJlY2VpdmVkUmVzcG9uc2VCb2R5ICYmIHRoaXMucmVjZWl2ZWRSZXNwb25zZVN0YXR1cztcbiAgfVxuXG4gIHByaXZhdGUgcmVjb3JkTWV0cmljcygpOiB2b2lkIHtcbiAgICBjb25zdCBlbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgbWV0cmljczogUmVxdWVzdE1ldHJpY3MgPSB7XG4gICAgICBudW1BY3RpdmVSZXF1ZXN0c0F0U3RhcnQ6IHRoaXMubnVtQWN0aXZlUmVxdWVzdHNBdFN0YXJ0LFxuICAgICAgbnVtQWN0aXZlUmVxdWVzdHNBdEZpbmlzaDpcbiAgICAgICAgRXhwZXJpbWVudGFsTWV0cmljc0Nzdk1pZGRsZXdhcmUubnVtQWN0aXZlUmVxdWVzdHMsXG4gICAgICByZXF1ZXN0VHlwZTogdGhpcy5yZXF1ZXN0VHlwZSxcbiAgICAgIHN0YXR1czogdGhpcy5yZXNwb25zZVN0YXR1c0NvZGUsXG4gICAgICBzdGFydFRpbWU6IHRoaXMuc3RhcnRUaW1lLFxuICAgICAgcmVxdWVzdEJvZHlUaW1lOiB0aGlzLnJlcXVlc3RCb2R5VGltZSxcbiAgICAgIGVuZFRpbWU6IGVuZFRpbWUsXG4gICAgICBkdXJhdGlvbjogZW5kVGltZSAtIHRoaXMuc3RhcnRUaW1lLFxuICAgICAgcmVxdWVzdFNpemU6IHRoaXMucmVxdWVzdFNpemUsXG4gICAgICByZXNwb25zZVNpemU6IHRoaXMucmVzcG9uc2VTaXplLFxuICAgIH07XG5cbiAgICBjb25zdCBjc3ZSb3cgPSBbXG4gICAgICBtZXRyaWNzLm51bUFjdGl2ZVJlcXVlc3RzQXRTdGFydCxcbiAgICAgIG1ldHJpY3MubnVtQWN0aXZlUmVxdWVzdHNBdEZpbmlzaCxcbiAgICAgIG1ldHJpY3MucmVxdWVzdFR5cGUsXG4gICAgICBtZXRyaWNzLnN0YXR1cyxcbiAgICAgIG1ldHJpY3Muc3RhcnRUaW1lLFxuICAgICAgbWV0cmljcy5yZXF1ZXN0Qm9keVRpbWUsXG4gICAgICBtZXRyaWNzLmVuZFRpbWUsXG4gICAgICBtZXRyaWNzLmR1cmF0aW9uLFxuICAgICAgbWV0cmljcy5yZXF1ZXN0U2l6ZSxcbiAgICAgIG1ldHJpY3MucmVzcG9uc2VTaXplLFxuICAgIF0uam9pbignLCcpO1xuICAgIGZzLmFwcGVuZEZpbGUodGhpcy5jc3ZQYXRoLCBgJHtjc3ZSb3d9XFxuYCwgZXJyID0+IHtcbiAgICAgIGlmIChlcnIgIT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgJ0Vycm9yIHdyaXRpbmcgdG8gbWV0cmljcyBjc3YgZmlsZSBhdCBwYXRoOiAlcyA6ICVzJyxcbiAgICAgICAgICB0aGlzLmNzdlBhdGgsXG4gICAgICAgICAgZXJyXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgRXhwZXJpbWVudGFsTWV0cmljc0Nzdk1pZGRsZXdhcmUubnVtQWN0aXZlUmVxdWVzdHMtLTtcbiAgfVxufVxuXG4vKipcbiAqIFRoaXMgbWlkZGxld2FyZSBlbmFibGVzIHBlci1yZXF1ZXN0IGNsaWVudC1zaWRlIG1ldHJpY3MuICBNZXRyaWNzIGZvciBlYWNoXG4gKiByZXF1ZXN0IHdpbGwgYmUgd3JpdHRlbiB0byBhIENTViBmaWxlOyB0aGlzIGZpbGUgY2FuIGJlIGFuYWx5emVkIG9yIHNoYXJlZFxuICogd2l0aCBNb21lbnRvIHRvIGRpYWdub3NlIHBlcmZvcm1hbmNlIGlzc3Vlcy5cbiAqXG4gKiBUaGUgbWV0cmljcyBmb3JtYXQgaXMgY3VycmVudGx5IGNvbnNpZGVyZWQgZXhwZXJpbWVudGFsOyBpbiBhIGZ1dHVyZSByZWxlYXNlLFxuICogb25jZSB0aGUgZm9ybWF0IGlzIGNvbnNpZGVyZWQgc3RhYmxlLCB0aGlzIGNsYXNzIHdpbGwgYmUgcmVuYW1lZCB0byByZW1vdmVcbiAqIHRoZSBFeHBlcmltZW50YWwgcHJlZml4LlxuICpcbiAqIFdBUk5JTkc6IGVuYWJsaW5nIHRoaXMgbWlkZGxld2FyZSBtYXkgaGF2ZSBtaW5vciBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMsXG4gKiBzbyBlbmFibGUgd2l0aCBjYXV0aW9uLlxuICpcbiAqIFdBUk5JTkc6IGRlcGVuZGluZyBvbiB5b3VyIHJlcXVlc3Qgdm9sdW1lLCB0aGUgQ1NWIGZpbGUgc2l6ZSBtYXkgZ3JvdyBxdWlja2x5O1xuICogbmVpdGhlciBzYW1wbGluZyBub3IgZmlsZSBjb21wcmVzc2lvbiAvIHJvdGF0aW9uIGFyZSBpbmNsdWRlZCBhdCB0aGlzIHRpbWVcbiAqICh0aG91Z2ggdGhleSBtYXkgYmUgYWRkZWQgaW4gdGhlIGZ1dHVyZSkuXG4gKlxuICogU2VlIGBhZHZhbmNlZC50c2AgaW4gdGhlIGV4YW1wbGVzIGRpcmVjdG9yeSBmb3IgYW4gZXhhbXBsZSBvZiBob3cgdG8gc2V0IHVwXG4gKiB5b3VyIHtDb25maWd1cmF0aW9ufSB0byBlbmFibGUgdGhpcyBtaWRkbGV3YXJlLlxuICovXG5leHBvcnQgY2xhc3MgRXhwZXJpbWVudGFsTWV0cmljc0Nzdk1pZGRsZXdhcmUgaW1wbGVtZW50cyBNaWRkbGV3YXJlIHtcbiAgc3RhdGljIG51bUFjdGl2ZVJlcXVlc3RzID0gMDtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjc3ZQYXRoOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoY3N2UGF0aDogc3RyaW5nLCBsb2dnZXJGYWN0b3J5OiBNb21lbnRvTG9nZ2VyRmFjdG9yeSkge1xuICAgIHRoaXMuY3N2UGF0aCA9IGNzdlBhdGg7XG4gICAgdGhpcy5sb2dnZXIgPSBsb2dnZXJGYWN0b3J5LmdldExvZ2dlcih0aGlzKTtcbiAgICBmcy53cml0ZUZpbGVTeW5jKHRoaXMuY3N2UGF0aCwgYCR7aGVhZGVyRmllbGRzKCkuam9pbignLCcpfVxcbmApO1xuICB9XG5cbiAgb25OZXdSZXF1ZXN0KCk6IE1pZGRsZXdhcmVSZXF1ZXN0SGFuZGxlciB7XG4gICAgcmV0dXJuIG5ldyBFeHBlcmltZW50YWxNZXRyaWNzQ3N2TWlkZGxld2FyZVJlcXVlc3RIYW5kbGVyKFxuICAgICAgdGhpcy5sb2dnZXIsXG4gICAgICB0aGlzLmNzdlBhdGhcbiAgICApO1xuICB9XG59XG4iXX0=