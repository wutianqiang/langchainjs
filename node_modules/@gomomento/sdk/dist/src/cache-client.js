"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SimpleCacheClient = exports.CacheClient = void 0;
const control_client_1 = require("./internal/control-client");
const data_client_1 = require("./internal/data-client");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const AbstractCacheClient_1 = require("@gomomento/sdk-core/dist/src/internal/clients/cache/AbstractCacheClient");
/**
 * Momento Cache Client.
 *
 * Features include:
 * - Get, set, and delete data
 * - Create, delete, and list caches
 * - Create, revoke, and list signing keys
 */
class CacheClient extends AbstractCacheClient_1.AbstractCacheClient {
    /**
     * Creates an instance of CacheClient.
     */
    constructor(props) {
        const controlClient = new control_client_1.ControlClient({
            configuration: props.configuration,
            credentialProvider: props.credentialProvider,
        });
        // For high load, we get better performance with multiple clients.  Here we
        // are setting a default, hard-coded value for the number of clients to use,
        // because we haven't yet designed the API for users to use to configure
        // tunables:
        // https://github.com/momentohq/dev-eco-issue-tracker/issues/85
        // The choice of 6 as the initial value is a rough guess at a reasonable
        // default for the short-term, based on load testing results captured in:
        // https://github.com/momentohq/oncall-tracker/issues/186
        const numClients = 6;
        const dataClients = (0, utils_1.range)(numClients).map(() => new data_client_1.DataClient(props));
        super(controlClient, dataClients);
        this.notYetAbstractedControlClient = controlClient;
        this.logger = props.configuration.getLoggerFactory().getLogger(this);
        this.logger.info('Creating Momento CacheClient');
    }
    /**
     * Flushes / clears all the items of the given cache
     *
     * @param {string} cacheName - The cache to be flushed.
     * @returns {Promise<CacheFlush.Response>} -
     * {@link CacheFlush.Success} on success.
     * {@link CacheFlush.Error} on failure.
     */
    async flushCache(cacheName) {
        return await this.notYetAbstractedControlClient.flushCache(cacheName);
    }
    /**
     * Creates a Momento signing key.
     *
     * @param {number} ttlMinutes - The time to live in minutes until the Momento
     * signing key expires.
     * @returns {Promise<CreateSigningKey.Response>} -
     * {@link CreateSigningKey.Success} containing the key, key ID, endpoint, and
     * expiration date on success.
     * {@link CreateSigningKey.Error} on failure.
     */
    async createSigningKey(ttlMinutes) {
        const client = this.getNextDataClient();
        return await this.notYetAbstractedControlClient.createSigningKey(ttlMinutes, client.getEndpoint());
    }
    /**
     * Revokes a Momento signing key.
     *
     * @remarks
     * All tokens signed by this key will be invalid.
     *
     * @param {string} keyId - The ID of the key to revoke.
     * @returns {Promise<RevokeSigningKey.Response>} -
     * {@link RevokeSigningKey.Success} on success.
     * {@link RevokeSigningKey.Error} on failure.
     */
    async revokeSigningKey(keyId) {
        return await this.notYetAbstractedControlClient.revokeSigningKey(keyId);
    }
    /**
     * Lists all Momento signing keys for the provided auth token.
     *
     * @returns {Promise<ListSigningKeys.Response>} -
     * {@link ListSigningKeys.Success} containing the keys on success.
     * {@link ListSigningKeys.Error} on failure.
     */
    async listSigningKeys() {
        const client = this.getNextDataClient();
        return await this.notYetAbstractedControlClient.listSigningKeys(client.getEndpoint());
    }
    getNextDataClient() {
        const client = this.dataClients[this.nextDataClientIndex];
        this.nextDataClientIndex =
            (this.nextDataClientIndex + 1) % this.dataClients.length;
        return client;
    }
}
exports.CacheClient = CacheClient;
/**
 * @deprecated use {CacheClient} instead
 */
class SimpleCacheClient extends CacheClient {
}
exports.SimpleCacheClient = SimpleCacheClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NhY2hlLWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw4REFBd0Q7QUFDeEQsd0RBQWtEO0FBU2xELHVFQUFrRTtBQUVsRSxpSEFBNEc7QUFFNUc7Ozs7Ozs7R0FPRztBQUNILE1BQWEsV0FBWSxTQUFRLHlDQUFtQjtJQUlsRDs7T0FFRztJQUNILFlBQVksS0FBdUI7UUFDakMsTUFBTSxhQUFhLEdBQUcsSUFBSSw4QkFBYSxDQUFDO1lBQ3RDLGFBQWEsRUFBRSxLQUFLLENBQUMsYUFBYTtZQUNsQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsa0JBQWtCO1NBQzdDLENBQUMsQ0FBQztRQUVILDJFQUEyRTtRQUMzRSw0RUFBNEU7UUFDNUUsd0VBQXdFO1FBQ3hFLFlBQVk7UUFDWiwrREFBK0Q7UUFDL0Qsd0VBQXdFO1FBQ3hFLHlFQUF5RTtRQUN6RSx5REFBeUQ7UUFDekQsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLE1BQU0sV0FBVyxHQUFHLElBQUEsYUFBSyxFQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLHdCQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN2RSxLQUFLLENBQUMsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBRWxDLElBQUksQ0FBQyw2QkFBNkIsR0FBRyxhQUFhLENBQUM7UUFFbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSSxLQUFLLENBQUMsVUFBVSxDQUFDLFNBQWlCO1FBQ3ZDLE9BQU8sTUFBTSxJQUFJLENBQUMsNkJBQTZCLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSSxLQUFLLENBQUMsZ0JBQWdCLENBQzNCLFVBQWtCO1FBRWxCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3hDLE9BQU8sTUFBTSxJQUFJLENBQUMsNkJBQTZCLENBQUMsZ0JBQWdCLENBQzlELFVBQVUsRUFDVixNQUFNLENBQUMsV0FBVyxFQUFFLENBQ3JCLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7Ozs7Ozs7T0FVRztJQUNJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FDM0IsS0FBYTtRQUViLE9BQU8sTUFBTSxJQUFJLENBQUMsNkJBQTZCLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNJLEtBQUssQ0FBQyxlQUFlO1FBQzFCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3hDLE9BQU8sTUFBTSxJQUFJLENBQUMsNkJBQTZCLENBQUMsZUFBZSxDQUM3RCxNQUFNLENBQUMsV0FBVyxFQUFFLENBQ3JCLENBQUM7SUFDSixDQUFDO0lBRVMsaUJBQWlCO1FBQ3pCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLG1CQUFtQjtZQUN0QixDQUFDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztRQUMzRCxPQUFPLE1BQW9CLENBQUM7SUFDOUIsQ0FBQztDQUNGO0FBcEdELGtDQW9HQztBQUVEOztHQUVHO0FBQ0gsTUFBYSxpQkFBa0IsU0FBUSxXQUFXO0NBQUc7QUFBckQsOENBQXFEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb250cm9sQ2xpZW50fSBmcm9tICcuL2ludGVybmFsL2NvbnRyb2wtY2xpZW50JztcbmltcG9ydCB7RGF0YUNsaWVudH0gZnJvbSAnLi9pbnRlcm5hbC9kYXRhLWNsaWVudCc7XG5pbXBvcnQge1xuICBDcmVhdGVTaWduaW5nS2V5LFxuICBMaXN0U2lnbmluZ0tleXMsXG4gIFJldm9rZVNpZ25pbmdLZXksXG4gIENhY2hlRmx1c2gsXG4gIE1vbWVudG9Mb2dnZXIsXG59IGZyb20gJy4nO1xuaW1wb3J0IHtDYWNoZUNsaWVudFByb3BzfSBmcm9tICcuL2NhY2hlLWNsaWVudC1wcm9wcyc7XG5pbXBvcnQge3JhbmdlfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7SUNhY2hlQ2xpZW50fSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2NsaWVudHMvSUNhY2hlQ2xpZW50JztcbmltcG9ydCB7QWJzdHJhY3RDYWNoZUNsaWVudH0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzL2NhY2hlL0Fic3RyYWN0Q2FjaGVDbGllbnQnO1xuXG4vKipcbiAqIE1vbWVudG8gQ2FjaGUgQ2xpZW50LlxuICpcbiAqIEZlYXR1cmVzIGluY2x1ZGU6XG4gKiAtIEdldCwgc2V0LCBhbmQgZGVsZXRlIGRhdGFcbiAqIC0gQ3JlYXRlLCBkZWxldGUsIGFuZCBsaXN0IGNhY2hlc1xuICogLSBDcmVhdGUsIHJldm9rZSwgYW5kIGxpc3Qgc2lnbmluZyBrZXlzXG4gKi9cbmV4cG9ydCBjbGFzcyBDYWNoZUNsaWVudCBleHRlbmRzIEFic3RyYWN0Q2FjaGVDbGllbnQgaW1wbGVtZW50cyBJQ2FjaGVDbGllbnQge1xuICBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogTW9tZW50b0xvZ2dlcjtcbiAgcHJpdmF0ZSByZWFkb25seSBub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudDogQ29udHJvbENsaWVudDtcblxuICAvKipcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBDYWNoZUNsaWVudC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBDYWNoZUNsaWVudFByb3BzKSB7XG4gICAgY29uc3QgY29udHJvbENsaWVudCA9IG5ldyBDb250cm9sQ2xpZW50KHtcbiAgICAgIGNvbmZpZ3VyYXRpb246IHByb3BzLmNvbmZpZ3VyYXRpb24sXG4gICAgICBjcmVkZW50aWFsUHJvdmlkZXI6IHByb3BzLmNyZWRlbnRpYWxQcm92aWRlcixcbiAgICB9KTtcblxuICAgIC8vIEZvciBoaWdoIGxvYWQsIHdlIGdldCBiZXR0ZXIgcGVyZm9ybWFuY2Ugd2l0aCBtdWx0aXBsZSBjbGllbnRzLiAgSGVyZSB3ZVxuICAgIC8vIGFyZSBzZXR0aW5nIGEgZGVmYXVsdCwgaGFyZC1jb2RlZCB2YWx1ZSBmb3IgdGhlIG51bWJlciBvZiBjbGllbnRzIHRvIHVzZSxcbiAgICAvLyBiZWNhdXNlIHdlIGhhdmVuJ3QgeWV0IGRlc2lnbmVkIHRoZSBBUEkgZm9yIHVzZXJzIHRvIHVzZSB0byBjb25maWd1cmVcbiAgICAvLyB0dW5hYmxlczpcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50b2hxL2Rldi1lY28taXNzdWUtdHJhY2tlci9pc3N1ZXMvODVcbiAgICAvLyBUaGUgY2hvaWNlIG9mIDYgYXMgdGhlIGluaXRpYWwgdmFsdWUgaXMgYSByb3VnaCBndWVzcyBhdCBhIHJlYXNvbmFibGVcbiAgICAvLyBkZWZhdWx0IGZvciB0aGUgc2hvcnQtdGVybSwgYmFzZWQgb24gbG9hZCB0ZXN0aW5nIHJlc3VsdHMgY2FwdHVyZWQgaW46XG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudG9ocS9vbmNhbGwtdHJhY2tlci9pc3N1ZXMvMTg2XG4gICAgY29uc3QgbnVtQ2xpZW50cyA9IDY7XG4gICAgY29uc3QgZGF0YUNsaWVudHMgPSByYW5nZShudW1DbGllbnRzKS5tYXAoKCkgPT4gbmV3IERhdGFDbGllbnQocHJvcHMpKTtcbiAgICBzdXBlcihjb250cm9sQ2xpZW50LCBkYXRhQ2xpZW50cyk7XG5cbiAgICB0aGlzLm5vdFlldEFic3RyYWN0ZWRDb250cm9sQ2xpZW50ID0gY29udHJvbENsaWVudDtcblxuICAgIHRoaXMubG9nZ2VyID0gcHJvcHMuY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCkuZ2V0TG9nZ2VyKHRoaXMpO1xuICAgIHRoaXMubG9nZ2VyLmluZm8oJ0NyZWF0aW5nIE1vbWVudG8gQ2FjaGVDbGllbnQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGbHVzaGVzIC8gY2xlYXJzIGFsbCB0aGUgaXRlbXMgb2YgdGhlIGdpdmVuIGNhY2hlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZU5hbWUgLSBUaGUgY2FjaGUgdG8gYmUgZmx1c2hlZC5cbiAgICogQHJldHVybnMge1Byb21pc2U8Q2FjaGVGbHVzaC5SZXNwb25zZT59IC1cbiAgICoge0BsaW5rIENhY2hlRmx1c2guU3VjY2Vzc30gb24gc3VjY2Vzcy5cbiAgICoge0BsaW5rIENhY2hlRmx1c2guRXJyb3J9IG9uIGZhaWx1cmUuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZmx1c2hDYWNoZShjYWNoZU5hbWU6IHN0cmluZyk6IFByb21pc2U8Q2FjaGVGbHVzaC5SZXNwb25zZT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLm5vdFlldEFic3RyYWN0ZWRDb250cm9sQ2xpZW50LmZsdXNoQ2FjaGUoY2FjaGVOYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGEgTW9tZW50byBzaWduaW5nIGtleS5cbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHR0bE1pbnV0ZXMgLSBUaGUgdGltZSB0byBsaXZlIGluIG1pbnV0ZXMgdW50aWwgdGhlIE1vbWVudG9cbiAgICogc2lnbmluZyBrZXkgZXhwaXJlcy5cbiAgICogQHJldHVybnMge1Byb21pc2U8Q3JlYXRlU2lnbmluZ0tleS5SZXNwb25zZT59IC1cbiAgICoge0BsaW5rIENyZWF0ZVNpZ25pbmdLZXkuU3VjY2Vzc30gY29udGFpbmluZyB0aGUga2V5LCBrZXkgSUQsIGVuZHBvaW50LCBhbmRcbiAgICogZXhwaXJhdGlvbiBkYXRlIG9uIHN1Y2Nlc3MuXG4gICAqIHtAbGluayBDcmVhdGVTaWduaW5nS2V5LkVycm9yfSBvbiBmYWlsdXJlLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGNyZWF0ZVNpZ25pbmdLZXkoXG4gICAgdHRsTWludXRlczogbnVtYmVyXG4gICk6IFByb21pc2U8Q3JlYXRlU2lnbmluZ0tleS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudC5jcmVhdGVTaWduaW5nS2V5KFxuICAgICAgdHRsTWludXRlcyxcbiAgICAgIGNsaWVudC5nZXRFbmRwb2ludCgpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXZva2VzIGEgTW9tZW50byBzaWduaW5nIGtleS5cbiAgICpcbiAgICogQHJlbWFya3NcbiAgICogQWxsIHRva2VucyBzaWduZWQgYnkgdGhpcyBrZXkgd2lsbCBiZSBpbnZhbGlkLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5SWQgLSBUaGUgSUQgb2YgdGhlIGtleSB0byByZXZva2UuXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFJldm9rZVNpZ25pbmdLZXkuUmVzcG9uc2U+fSAtXG4gICAqIHtAbGluayBSZXZva2VTaWduaW5nS2V5LlN1Y2Nlc3N9IG9uIHN1Y2Nlc3MuXG4gICAqIHtAbGluayBSZXZva2VTaWduaW5nS2V5LkVycm9yfSBvbiBmYWlsdXJlLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIHJldm9rZVNpZ25pbmdLZXkoXG4gICAga2V5SWQ6IHN0cmluZ1xuICApOiBQcm9taXNlPFJldm9rZVNpZ25pbmdLZXkuUmVzcG9uc2U+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudC5yZXZva2VTaWduaW5nS2V5KGtleUlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0cyBhbGwgTW9tZW50byBzaWduaW5nIGtleXMgZm9yIHRoZSBwcm92aWRlZCBhdXRoIHRva2VuLlxuICAgKlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxMaXN0U2lnbmluZ0tleXMuUmVzcG9uc2U+fSAtXG4gICAqIHtAbGluayBMaXN0U2lnbmluZ0tleXMuU3VjY2Vzc30gY29udGFpbmluZyB0aGUga2V5cyBvbiBzdWNjZXNzLlxuICAgKiB7QGxpbmsgTGlzdFNpZ25pbmdLZXlzLkVycm9yfSBvbiBmYWlsdXJlLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGxpc3RTaWduaW5nS2V5cygpOiBQcm9taXNlPExpc3RTaWduaW5nS2V5cy5SZXNwb25zZT4ge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuZ2V0TmV4dERhdGFDbGllbnQoKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudC5saXN0U2lnbmluZ0tleXMoXG4gICAgICBjbGllbnQuZ2V0RW5kcG9pbnQoKVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0TmV4dERhdGFDbGllbnQoKTogRGF0YUNsaWVudCB7XG4gICAgY29uc3QgY2xpZW50ID0gdGhpcy5kYXRhQ2xpZW50c1t0aGlzLm5leHREYXRhQ2xpZW50SW5kZXhdO1xuICAgIHRoaXMubmV4dERhdGFDbGllbnRJbmRleCA9XG4gICAgICAodGhpcy5uZXh0RGF0YUNsaWVudEluZGV4ICsgMSkgJSB0aGlzLmRhdGFDbGllbnRzLmxlbmd0aDtcbiAgICByZXR1cm4gY2xpZW50IGFzIERhdGFDbGllbnQ7XG4gIH1cbn1cblxuLyoqXG4gKiBAZGVwcmVjYXRlZCB1c2Uge0NhY2hlQ2xpZW50fSBpbnN0ZWFkXG4gKi9cbmV4cG9ydCBjbGFzcyBTaW1wbGVDYWNoZUNsaWVudCBleHRlbmRzIENhY2hlQ2xpZW50IHt9XG4iXX0=